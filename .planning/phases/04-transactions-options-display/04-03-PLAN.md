---
phase: 04-transactions-options-display
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/options/page.tsx
  - src/components/options/options-dashboard.tsx
  - src/components/options/options-stat-cards.tsx
  - src/components/options/options-columns.tsx
  - src/components/options/wheel-table.tsx
  - src/components/options/leaps-table.tsx
  - src/components/options/all-options-table.tsx
autonomous: true

must_haves:
  truths:
    - "Options page shows Wheel, LEAPS, and All tabs"
    - "Stat cards display total premium collected, capital gains P&L, win rate, and avg days held -- always showing overall totals regardless of active tab"
    - "Wheel table shows Open and Closed positions with status column, expiry highlighting (amber <7d, red past due), and dimmed closed rows"
    - "Roll chains display as expandable rows with indented sub-rows showing individual legs and cumulative P&L on parent"
    - "LEAPS table shows current price, days to expiry, premium paid, current P&L, delta, IV%, plus intrinsic/extrinsic value columns"
    - "All tab shows unified table of all options with strategy_type column"
    - "Profit/loss values use green text for gains, red text for losses"
  artifacts:
    - path: "src/app/options/page.tsx"
      provides: "Server Component fetching all options data and rendering OptionsDashboard"
    - path: "src/components/options/options-dashboard.tsx"
      provides: "Client Component with tab container orchestrating stat cards and tab content"
    - path: "src/components/options/options-stat-cards.tsx"
      provides: "Four stat cards rendering overall options statistics"
    - path: "src/components/options/options-columns.tsx"
      provides: "Column definitions for Wheel, LEAPS, and All options tables"
      exports: ["wheelColumns", "leapsColumns", "allColumns"]
    - path: "src/components/options/wheel-table.tsx"
      provides: "Wheel positions table with expandable roll chain rows and expiry highlighting"
    - path: "src/components/options/leaps-table.tsx"
      provides: "LEAPS positions table with computed derived columns"
    - path: "src/components/options/all-options-table.tsx"
      provides: "Unified options table showing all strategies"
  key_links:
    - from: "src/app/options/page.tsx"
      to: "src/lib/options.ts"
      via: "import getOptionsPageData"
      pattern: "import.*getOptionsPageData.*options"
    - from: "src/components/options/options-dashboard.tsx"
      to: "src/components/options/wheel-table.tsx"
      via: "renders WheelTable inside TabsContent"
      pattern: "<WheelTable"
    - from: "src/components/options/wheel-table.tsx"
      to: "src/lib/options.ts"
      via: "import buildOptionsRows, OptionsRow"
      pattern: "import.*(buildOptionsRows|OptionsRow).*options"
---

<objective>
Build the complete options dashboard page with Wheel/LEAPS/All tabs, stat cards, roll chain grouping, expiry highlighting, and LEAPS derived columns.

Purpose: Covers requirements OPTS-01 through OPTS-06. Users can view all options positions organised by strategy, with visual cues for expiring positions and profit/loss, and expandable roll chain history.

Output: 7 files forming the complete options dashboard vertical slice.
</objective>

<execution_context>
@/Users/skylight/.claude/sky/workflows/execute-plan.md
@/Users/skylight/.claude/sky/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-transactions-options-display/04-RESEARCH.md
@.planning/phases/04-transactions-options-display/04-CONTEXT.md
@.planning/phases/04-transactions-options-display/04-01-SUMMARY.md
@src/lib/types.ts
@src/lib/options.ts
@src/lib/format.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create column definitions and stat cards</name>
  <files>src/components/options/options-columns.tsx, src/components/options/options-stat-cards.tsx</files>
  <action>
**`src/components/options/options-columns.tsx`:**
Define three sets of TanStack Table column definitions. Import ColumnDef from @tanstack/react-table. Import formatCurrency, formatPercent, formatNumber, formatDate, daysToExpiry, pnlClassName from "@/lib/format". Import Badge from "@/components/ui/badge". Import Button from "@/components/ui/button". Import ChevronRight, ChevronDown from "lucide-react". Import type OptionsRow, LeapsDisplayRow from "@/lib/options".

**wheelColumns** (ColumnDef<OptionsRow>[]):
1. **expand** -- no header, cell: if row has subRows, render a button with ChevronRight/ChevronDown icon that calls row.toggleExpanded(). Width 40px.
2. **ticker** -- header "Ticker", cell: `row.original.option.ticker`, monospace bold, sortable
3. **opened** -- header "Opened", cell: `formatDate(row.original.option.opened)`, sortable
4. **call_put** -- header "C/P", cell: Badge with "Call" or "Put", sortable
5. **strike** -- header "Strike", cell: `formatCurrency(row.original.option.strike)`, right-aligned, sortable
6. **expiration** -- header "Expiration", cell: `formatDate(row.original.option.expiration)`, sortable
7. **dte** -- header "DTE", cell: computed `daysToExpiry(row.original.option.expiration)`. Display as number. Apply colour: red if < 0, amber if <= 7, default otherwise. Right-aligned.
8. **delta** -- header "Delta", cell: `row.original.option.delta != null ? formatNumber(row.original.option.delta, 3) : "—"`, right-aligned
9. **premium** -- header "Premium", cell: for chain heads show `cumulativePremium` with "chain" tooltip, otherwise `option.premium`. Use `formatCurrency()`. Right-aligned.
10. **collateral** -- header "Collateral", cell: `option.collateral != null ? formatCurrency(option.collateral) : "—"`, right-aligned
11. **profit** -- header "Profit", cell: for chain heads show `cumulativeProfit`, otherwise `option.profit`. Apply pnlClassName. Use formatCurrency. Right-aligned.
12. **return_pct** -- header "Return%", cell: `option.return_pct != null ? formatPercent(option.return_pct) : "—"`, apply pnlClassName, right-aligned
13. **annualised_return_pct** -- header "Ann. Return%", cell: `option.annualised_return_pct != null ? formatPercent(option.annualised_return_pct) : "—"`, apply pnlClassName, right-aligned
14. **status** -- header "Status", cell: Status badge. Variants: Open = blue bg, Closed = muted, Expired = muted, Rolled = amber bg, Assigned = purple bg. All use outline badge variant with custom className.

For sub-rows (roll chain legs, row.depth > 0): indent the ticker column content with `pl-${row.depth * 6}`. Show individual profit/premium (not cumulative).

**leapsColumns** (ColumnDef<LeapsDisplayRow>[]):
1. **ticker** -- same as wheel
2. **opened** -- same as wheel
3. **call_put** -- same as wheel
4. **strike** -- same as wheel
5. **currentPrice** -- header "Current Price", cell: `row.original.currentPrice != null ? formatCurrency(row.original.currentPrice) : "N/A"`, right-aligned
6. **expiration** -- same as wheel
7. **dte** -- header "DTE", cell: `row.original.daysToExpiry`. Colour same as wheel.
8. **premium** -- header "Premium Paid", cell: `formatCurrency(row.original.premium)`, right-aligned
9. **currentPnl** -- header "Current P&L", cell: `row.original.currentPnl != null ? formatCurrency(row.original.currentPnl) : "N/A"`, apply pnlClassName, right-aligned
10. **delta** -- header "Delta", cell: same as wheel
11. **iv_pct** -- header "IV%", cell: `row.original.iv_pct != null ? formatPercent(row.original.iv_pct) : "—"`, right-aligned
12. **intrinsicValue** -- header "Intrinsic", cell: `row.original.intrinsicValue != null ? formatCurrency(row.original.intrinsicValue) : "N/A"`, right-aligned
13. **extrinsicValue** -- header "Extrinsic", cell: `row.original.extrinsicValue != null ? formatCurrency(row.original.extrinsicValue) : "N/A"`, right-aligned
14. **status** -- same as wheel

**allColumns** (ColumnDef<OptionsRow>[]):
Same as wheelColumns but add a **strategy_type** column (header "Strategy", cell: Badge with strategy_type value) after ticker. Remove the expand column (no roll chain grouping in All view -- show flat list).

**`src/components/options/options-stat-cards.tsx`** ("use client"):

Props: `{ stats: OptionsStats }`

Render 4 cards in a responsive grid (`grid grid-cols-2 lg:grid-cols-4 gap-4`):

1. **Total Premium Collected** -- Card with title "Premium Collected", value `formatCurrency(stats.totalPremiumCollected)`, icon DollarSign from lucide-react
2. **Capital Gains P&L** -- Card with title "Capital Gains P&L", value `formatCurrency(stats.capitalGainsPnl)`, apply pnlClassName to value, icon TrendingUp from lucide-react
3. **Win Rate** -- Card with title "Win Rate", value `formatPercent(stats.winRate)` (but no sign prefix -- just "XX.XX%"), icon Target from lucide-react
4. **Avg Days Held** -- Card with title "Avg Days Held", value `Math.round(stats.avgDaysHeld)` + " days", icon Clock from lucide-react

Each card uses Card/CardHeader/CardTitle/CardContent from shadcn. CardHeader has a flex row with title on left, icon on right (text-muted-foreground). CardContent has the value in a large bold font (`text-2xl font-bold`).

Import OptionsStats from "@/lib/options".
  </action>
  <verify>`pnpm typecheck` passes. Both files export their named exports correctly.</verify>
  <done>Column definitions for all three table variants (Wheel, LEAPS, All) are defined with proper formatting, sorting, and status badges. Stat cards render all four metrics with correct formatting.</done>
</task>

<task type="auto">
  <name>Task 2: Create Wheel, LEAPS, All tables and dashboard page</name>
  <files>src/components/options/wheel-table.tsx, src/components/options/leaps-table.tsx, src/components/options/all-options-table.tsx, src/components/options/options-dashboard.tsx, src/app/options/page.tsx</files>
  <action>
**`src/components/options/wheel-table.tsx`** ("use client"):

Props: `{ options: OptionRecord[], symbolPrices: Record<string, number> }`

Implementation:
1. Compute display data with useMemo: filter options to strategy_type === "Wheel", then call `buildOptionsRows(wheelOptions)` from "@/lib/options" to get OptionsRow[] with roll chains.
2. TanStack Table setup with expandable rows:
```typescript
const [sorting, setSorting] = useState<SortingState>([])
const [expanded, setExpanded] = useState<ExpandedState>({})

const table = useReactTable({
  data: rows,
  columns: wheelColumns,
  state: { sorting, expanded },
  onSortingChange: setSorting,
  onExpandedChange: setExpanded,
  getSubRows: (row) => row.subRows,
  getCoreRowModel: getCoreRowModel(),
  getSortedRowModel: getSortedRowModel(),
  getExpandedRowModel: getExpandedRowModel(),
})
```

3. Render table with conditional row styling:
- For each row, check the option's status and expiration:
  - If status is "Open" and DTE < 0: `bg-destructive/10` (red -- past expiration)
  - If status is "Open" and DTE <= 7: `bg-amber-500/10` (amber -- expiring soon)
  - If status is not "Open": `opacity-60` (dimmed for closed/expired/assigned/rolled)
- For sub-rows (row.depth > 0): additional `border-l-2 border-muted` on the left for visual chain indication

Use getDteStatus utility (inline or imported) to determine the row class.

Import Table/TableHeader/TableBody/TableRow/TableHead/TableCell from shadcn table. Import flexRender, getCoreRowModel, getSortedRowModel, getExpandedRowModel from @tanstack/react-table. Import cn from "@/lib/utils". Import wheelColumns from "./options-columns". Import buildOptionsRows, type OptionsRow from "@/lib/options". Import daysToExpiry from "@/lib/format".

**`src/components/options/leaps-table.tsx`** ("use client"):

Props: `{ options: OptionRecord[], symbolPrices: Record<string, number> }`

Implementation:
1. Compute display data with useMemo: filter options to strategy_type === "LEAPS", then compute LeapsDisplayRow for each using `computeLeapsDisplay(opt, symbolPrices[opt.ticker] ?? null)` from "@/lib/options".
2. Also apply roll chain grouping for LEAPS -- call buildOptionsRows on the LEAPS-only options for chain grouping in a secondary view. But for the primary LEAPS table, use the flat LeapsDisplayRow[] with leapsColumns (since LEAPS columns need the derived fields).

Actually, reconcile: The LEAPS table needs both roll chain grouping AND the derived columns. The approach:
- Compute LeapsDisplayRow[] for all LEAPS options
- For roll chain display, build a separate OptionsRow[] structure from the raw LEAPS options for chain grouping
- For the primary table view, use the flat LeapsDisplayRow[] with leapsColumns (simpler, all derived columns visible)
- Roll chains in LEAPS use the same expandable row pattern as Wheel

Simplification: Since LEAPS typically has ~35 positions and roll chains are less common in LEAPS, use a flat table with LeapsDisplayRow[] and leapsColumns. Skip roll chain sub-rows for LEAPS to reduce complexity. If roll chains are present, they show as individual rows with "Rolled" status badge.

3. TanStack Table setup (same pattern as Wheel but without expandable rows):
```typescript
const table = useReactTable({
  data: leapsRows,
  columns: leapsColumns,
  state: { sorting },
  onSortingChange: setSorting,
  getCoreRowModel: getCoreRowModel(),
  getSortedRowModel: getSortedRowModel(),
})
```

4. Row styling: same DTE highlighting as Wheel. Dimmed for non-Open status.

Import computeLeapsDisplay, type LeapsDisplayRow from "@/lib/options". Import leapsColumns from "./options-columns".

**`src/components/options/all-options-table.tsx`** ("use client"):

Props: `{ options: OptionRecord[] }`

Implementation:
1. Build OptionsRow[] from all options (flat, no roll chains -- All view shows every option as individual row).
2. TanStack Table with allColumns, sortable.
3. Same row styling (DTE highlighting + dimmed closed).

Import allColumns from "./options-columns".

**`src/components/options/options-dashboard.tsx`** ("use client"):

Props:
```typescript
interface OptionsDashboardProps {
  data: OptionsPageData
}
```

Layout:
```
<div className="space-y-6">
  <h1 className="text-2xl font-bold">Options</h1>

  {/* Stat cards ABOVE tabs -- always show overall totals */}
  <OptionsStatCards stats={data.stats} />

  {/* Tabs */}
  <Tabs defaultValue="wheel">
    <TabsList>
      <TabsTrigger value="wheel">Wheel</TabsTrigger>
      <TabsTrigger value="leaps">LEAPS</TabsTrigger>
      <TabsTrigger value="all">All</TabsTrigger>
    </TabsList>

    <TabsContent value="wheel">
      <WheelTable options={data.options} symbolPrices={data.symbolPrices} />
    </TabsContent>

    <TabsContent value="leaps">
      <LeapsTable options={data.options} symbolPrices={data.symbolPrices} />
    </TabsContent>

    <TabsContent value="all">
      <AllOptionsTable options={data.options} />
    </TabsContent>
  </Tabs>
</div>
```

Import Tabs/TabsList/TabsTrigger/TabsContent from "@/components/ui/tabs". Import all child components. Import type OptionsPageData from "@/lib/options".

**`src/app/options/page.tsx`** (Server Component):
Replace the placeholder:
```typescript
import { getOptionsPageData } from "@/lib/options"
import { OptionsDashboard } from "@/components/options/options-dashboard"

export default async function OptionsPage() {
  const data = await getOptionsPageData()
  return <OptionsDashboard data={data} />
}
```

Run `pnpm typecheck && pnpm lint` after creating all files.
  </action>
  <verify>`pnpm typecheck` passes. `pnpm lint` passes. Navigate to /options in browser -- dashboard renders with tabs, stat cards, and table content in each tab.</verify>
  <done>Options dashboard is complete: three tabs (Wheel, LEAPS, All) render with correct tables, stat cards show overall totals, Wheel table has expandable roll chains with expiry highlighting, LEAPS table shows derived columns, All tab shows unified flat view.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. /options page renders without errors
4. Wheel tab shows positions with status column, expandable roll chain rows, expiry highlighting
5. LEAPS tab shows positions with current price, DTE, intrinsic/extrinsic values, current P&L
6. All tab shows unified table with strategy_type column
7. Stat cards always show overall totals regardless of active tab
8. Profit/loss values are green for gains, red for losses
9. Closed positions are visually dimmed
10. Open positions with DTE <= 7 are highlighted amber, past due highlighted red
</verification>

<success_criteria>
- All OPTS-01 through OPTS-06 requirements met
- Stat cards are independent of tab state (placed above tabs)
- Roll chains display correctly with cumulative P&L on parent rows
- Expiry highlighting works for both Wheel and LEAPS tables
- LEAPS derived columns compute correctly from symbol current prices
- All tables are sortable
</success_criteria>

<output>
After completion, create `.planning/phases/04-transactions-options-display/04-03-SUMMARY.md`
</output>
