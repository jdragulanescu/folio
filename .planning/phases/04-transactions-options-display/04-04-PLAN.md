---
phase: 04-transactions-options-display
plan: 04
type: execute
wave: 3
depends_on: ["04-03"]
files_modified:
  - src/components/options/premium-chart.tsx
  - src/components/options/premium-chart-summary.tsx
  - src/components/options/options-dashboard.tsx
autonomous: true

must_haves:
  truths:
    - "Monthly premium bar chart displays on the options page with stacked Wheel and LEAPS bars for each month"
    - "Year selector dropdown switches between years, updating the chart data"
    - "All 12 months are shown on the X-axis with zero-fill for months with no premium"
    - "Chart tooltips show the breakdown of Wheel and LEAPS premium for each month"
    - "A summary version of the chart exists for embedding on the portfolio overview page"
  artifacts:
    - path: "src/components/options/premium-chart.tsx"
      provides: "Full monthly premium stacked bar chart with year selector"
      min_lines: 50
    - path: "src/components/options/premium-chart-summary.tsx"
      provides: "Compact summary version of premium chart for portfolio overview"
    - path: "src/components/options/options-dashboard.tsx"
      provides: "Updated dashboard with premium chart added below tabs"
  key_links:
    - from: "src/components/options/premium-chart.tsx"
      to: "src/lib/options.ts"
      via: "consumes MonthlyPremium[] data from OptionsPageData"
      pattern: "MonthlyPremium"
    - from: "src/components/options/options-dashboard.tsx"
      to: "src/components/options/premium-chart.tsx"
      via: "renders PremiumChart below tabs"
      pattern: "<PremiumChart"
---

<objective>
Build the monthly premium bar chart (stacked Wheel vs LEAPS) with year selector, and a compact summary version for the portfolio overview page.

Purpose: Covers requirement OPTS-07. Users can visualise their monthly premium collection by strategy, compare years, and see a quick summary on the portfolio overview.

Output: `premium-chart.tsx` (full chart), `premium-chart-summary.tsx` (summary), updated `options-dashboard.tsx` integrating the chart.
</objective>

<execution_context>
@/Users/skylight/.claude/sky/workflows/execute-plan.md
@/Users/skylight/.claude/sky/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-transactions-options-display/04-RESEARCH.md
@.planning/phases/04-transactions-options-display/04-CONTEXT.md
@.planning/phases/04-transactions-options-display/04-01-SUMMARY.md
@.planning/phases/04-transactions-options-display/04-03-SUMMARY.md
@src/lib/options.ts
@src/components/options/options-dashboard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create premium chart components</name>
  <files>src/components/options/premium-chart.tsx, src/components/options/premium-chart-summary.tsx</files>
  <action>
**`src/components/options/premium-chart.tsx`** ("use client"):

Full-size monthly premium stacked bar chart with year selector dropdown.

Props:
```typescript
interface PremiumChartProps {
  allOptions: OptionRecord[]
  initialYear?: number     // Default: current year
}
```

State:
- `selectedYear` (number, default: initialYear or current year)
- Compute `premiumByMonth` with useMemo: call `buildPremiumByMonth(allOptions, selectedYear)` from "@/lib/options". This returns MonthlyPremium[] with 12 entries (Jan-Dec), zero-filled.

Year options: derive available years from the options data (unique years from `opened` dates). Sort descending. Display as Select dropdown.

Chart data transformation: map MonthlyPremium[] to chart format:
```typescript
const chartData = premiumByMonth.map(pm => ({
  month: format(parseISO(pm.month + "-01"), "MMM"),  // "Jan", "Feb", etc.
  wheel: pm.wheel,
  leaps: pm.leaps,
}))
```

Chart config:
```typescript
const chartConfig = {
  wheel: { label: "Wheel", color: "var(--chart-1)" },
  leaps: { label: "LEAPS", color: "var(--chart-2)" },
} satisfies ChartConfig
```

Render:
```
<Card>
  <CardHeader className="flex flex-row items-center justify-between">
    <CardTitle>Monthly Premium</CardTitle>
    <Select value={String(selectedYear)} onValueChange={(v) => setSelectedYear(Number(v))}>
      <SelectTrigger className="w-[100px]">
        <SelectValue />
      </SelectTrigger>
      <SelectContent>
        {availableYears.map(y => (
          <SelectItem key={y} value={String(y)}>{y}</SelectItem>
        ))}
      </SelectContent>
    </Select>
  </CardHeader>
  <CardContent>
    <ChartContainer config={chartConfig} className="h-[300px] w-full">
      <BarChart data={chartData} accessibilityLayer>
        <CartesianGrid vertical={false} />
        <XAxis dataKey="month" tickLine={false} axisLine={false} />
        <YAxis tickFormatter={(v) => `$${v}`} />
        <ChartTooltip content={<ChartTooltipContent />} />
        <ChartLegend content={<ChartLegendContent />} />
        <Bar dataKey="wheel" stackId="premium" fill="var(--color-wheel)" radius={[0, 0, 0, 0]} />
        <Bar dataKey="leaps" stackId="premium" fill="var(--color-leaps)" radius={[4, 4, 0, 0]} />
      </BarChart>
    </ChartContainer>
  </CardContent>
</Card>
```

Note on stacking: Wheel bar on bottom, LEAPS on top. Only the top bar (leaps) gets rounded top corners. If the user prefers side-by-side, remove `stackId` -- but context says "Claude decides best grouping approach" and stacked is preferred since Wheel is the primary source.

Import: ChartContainer, ChartTooltip, ChartTooltipContent, ChartLegend, ChartLegendContent, type ChartConfig from "@/components/ui/chart". Import BarChart, Bar, XAxis, YAxis, CartesianGrid from "recharts". Import Card/CardHeader/CardTitle/CardContent from "@/components/ui/card". Import Select/SelectTrigger/SelectValue/SelectContent/SelectItem from "@/components/ui/select". Import buildPremiumByMonth from "@/lib/options". Import type OptionRecord from "@/lib/types". Import format, parseISO from "date-fns".

**`src/components/options/premium-chart-summary.tsx`** ("use client"):

Compact version of the premium chart for embedding on the portfolio overview page. Same data, smaller size, no year selector (shows current year only), no legend.

Props:
```typescript
interface PremiumChartSummaryProps {
  premiumByMonth: MonthlyPremium[]
}
```

Render a smaller chart (h-[180px]) inside a Card with title "Options Premium". No year selector. Simplified: no legend, smaller axis labels. Include a total premium number in the card header.

```
<Card>
  <CardHeader>
    <CardTitle className="text-sm font-medium">Options Premium</CardTitle>
    <p className="text-2xl font-bold">{formatCurrency(totalPremium)}</p>
  </CardHeader>
  <CardContent>
    <ChartContainer config={chartConfig} className="h-[180px] w-full">
      <BarChart data={chartData} accessibilityLayer>
        <XAxis dataKey="month" tickLine={false} axisLine={false} tick={{ fontSize: 10 }} />
        <YAxis hide />
        <ChartTooltip content={<ChartTooltipContent />} />
        <Bar dataKey="wheel" stackId="premium" fill="var(--color-wheel)" radius={[0, 0, 0, 0]} />
        <Bar dataKey="leaps" stackId="premium" fill="var(--color-leaps)" radius={[4, 4, 0, 0]} />
      </BarChart>
    </ChartContainer>
  </CardContent>
</Card>
```

Compute totalPremium as sum of all wheel + leaps values in the premiumByMonth array. Import MonthlyPremium from "@/lib/options". Import formatCurrency from "@/lib/format".
  </action>
  <verify>`pnpm typecheck` passes. Both chart components exist and export correctly.</verify>
  <done>Full premium chart with year selector and compact summary chart are complete. Both use stacked bar format with Wheel + LEAPS breakdown.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate premium chart into options dashboard</name>
  <files>src/components/options/options-dashboard.tsx</files>
  <action>
Update `src/components/options/options-dashboard.tsx` to include the PremiumChart below the tabs.

Add import:
```typescript
import { PremiumChart } from "./premium-chart"
```

Add below the closing `</Tabs>` tag:
```tsx
{/* Premium Chart */}
<PremiumChart allOptions={data.options} />
```

The layout becomes:
```
<div className="space-y-6">
  <h1>Options</h1>
  <OptionsStatCards stats={data.stats} />
  <Tabs>...</Tabs>
  <PremiumChart allOptions={data.options} />
</div>
```

Run `pnpm typecheck && pnpm lint` after the update.
  </action>
  <verify>`pnpm typecheck` passes. `pnpm lint` passes. Navigate to /options -- premium chart renders below the tab tables with year selector and stacked bars.</verify>
  <done>Premium chart is integrated into the options dashboard. Full chart with year selector shows below tabs. Summary chart component is available for Phase 3 portfolio overview integration.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. /options page shows the premium chart below the tabs
4. Year selector switches chart data between available years
5. All 12 months displayed on X-axis (zero-filled where no data)
6. Stacked bars show Wheel (bottom) and LEAPS (top)
7. Tooltips show breakdown values
8. Summary chart component renders correctly in isolation
</verification>

<success_criteria>
- OPTS-07 requirement met: monthly premium bar chart with X=month, Y=premium, grouped by Wheel vs LEAPS
- Year selector provides navigation between years
- Empty months show as zero-height bars (no gaps in X-axis)
- Summary chart is self-contained and ready for embedding in portfolio overview page
</success_criteria>

<output>
After completion, create `.planning/phases/04-transactions-options-display/04-04-SUMMARY.md`
</output>
