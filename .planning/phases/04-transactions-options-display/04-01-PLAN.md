---
phase: 04-transactions-options-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/format.ts
  - src/lib/transactions.ts
  - src/lib/options.ts
  - src/actions/load-transactions.ts
  - src/components/ui/table.tsx
  - src/components/ui/tabs.tsx
  - src/components/ui/card.tsx
  - src/components/ui/badge.tsx
  - src/components/ui/chart.tsx
  - src/components/ui/select.tsx
  - src/components/ui/calendar.tsx
  - src/components/ui/popover.tsx
  - src/components/ui/toggle-group.tsx
autonomous: true

must_haves:
  truths:
    - "getTransactionsPage() returns 50 transactions sorted by date descending with correct totalRows and hasMore"
    - "getTransactionsPage() accepts filters (symbol, platform, type, dateFrom, dateTo) and builds valid NocoDB where clauses"
    - "getOptionsPageData() returns all options with computed stats (totalPremiumCollected, capitalGainsPnl, winRate, avgDaysHeld)"
    - "Roll chains are correctly inferred by matching ticker + Rolled status + temporal proximity"
    - "LEAPS display rows include computed intrinsicValue, extrinsicValue, daysToExpiry, currentPnl from symbols current_price"
    - "premiumByMonth array includes all 12 months for the selected year with zero-fill for empty months"
    - "loadMoreTransactions Server Action returns the next page of transactions with filters applied"
  artifacts:
    - path: "src/lib/format.ts"
      provides: "Centralised financial formatting utilities"
      exports: ["formatCurrency", "formatPercent", "formatNumber", "formatDate", "formatDateShort", "daysToExpiry", "pnlClassName"]
    - path: "src/lib/transactions.ts"
      provides: "Server-side transaction data assembly with pagination"
      exports: ["getTransactionsPage", "TransactionsPage", "TransactionFilters", "TRANSACTIONS_PAGE_SIZE"]
    - path: "src/lib/options.ts"
      provides: "Server-side options data assembly with roll chains, stats, LEAPS computations, premium chart data"
      exports: ["getOptionsPageData", "OptionsPageData", "OptionsStats", "RollChain", "OptionsRow", "LeapsDisplayRow", "MonthlyPremium", "inferRollChains", "computeLeapsDisplay"]
    - path: "src/actions/load-transactions.ts"
      provides: "Server Action for infinite scroll pagination"
      exports: ["loadMoreTransactions"]
  key_links:
    - from: "src/lib/transactions.ts"
      to: "src/lib/nocodb.ts"
      via: "import listRecords"
      pattern: "import.*listRecords.*nocodb"
    - from: "src/lib/options.ts"
      to: "src/lib/nocodb.ts"
      via: "import getAllRecords, fetchParallel"
      pattern: "import.*(getAllRecords|fetchParallel).*nocodb"
    - from: "src/actions/load-transactions.ts"
      to: "src/lib/transactions.ts"
      via: "import getTransactionsPage"
      pattern: "import.*getTransactionsPage.*transactions"
---

<objective>
Install all Phase 4 dependencies (npm packages + shadcn components), create the server-side data assembly layer for both pages, and build the shared formatting utilities.

Purpose: Every UI component in Plans 02-04 depends on the data shapes, Server Actions, and formatting utilities created here. This plan establishes the data contract between server and client without building any UI.

Output: `src/lib/transactions.ts` (paginated transaction fetching), `src/lib/options.ts` (options data assembly with roll chains, stats, LEAPS computations, premium chart data), `src/lib/format.ts` (shared formatters), `src/actions/load-transactions.ts` (Server Action), plus all shadcn/npm dependencies installed.
</objective>

<execution_context>
@/Users/skylight/.claude/sky/workflows/execute-plan.md
@/Users/skylight/.claude/sky/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-transactions-options-display/04-RESEARCH.md
@src/lib/nocodb.ts
@src/lib/types.ts
@src/lib/calculations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and shadcn components</name>
  <files>package.json, src/components/ui/*.tsx (shadcn generated)</files>
  <action>
Install npm packages (skip any already present in package.json):
```bash
pnpm add @tanstack/react-table recharts date-fns react-day-picker
```

Install shadcn components (skip any already in src/components/ui/):
```bash
pnpm dlx shadcn@latest add table tabs card badge chart select calendar popover toggle-group
```

If Phase 3 has already installed some of these (check package.json for @tanstack/react-table, recharts; check src/components/ui/ for table.tsx, card.tsx, badge.tsx, chart.tsx), skip the duplicates. The shadcn CLI will warn about existing components -- accept the overwrite prompt or skip.

After installation, run `pnpm typecheck` to verify no type errors.
  </action>
  <verify>`pnpm typecheck` passes. `ls src/components/ui/` shows table.tsx, tabs.tsx, card.tsx, badge.tsx, chart.tsx, select.tsx, calendar.tsx, popover.tsx, toggle-group.tsx. package.json includes @tanstack/react-table, recharts, date-fns, react-day-picker.</verify>
  <done>All Phase 4 dependencies installed. Type check passes.</done>
</task>

<task type="auto">
  <name>Task 2: Create format.ts, transactions.ts, options.ts, and Server Action</name>
  <files>src/lib/format.ts, src/lib/transactions.ts, src/lib/options.ts, src/actions/load-transactions.ts</files>
  <action>
**If `src/lib/format.ts` already exists (created by Phase 3 plan 03-01), skip this file.** If it does not exist, create it with these exports:

`src/lib/format.ts`:
- `formatCurrency(value: number, currency?: "USD" | "GBP"): string` -- Intl.NumberFormat en-GB, 2dp
- `formatPercent(value: number): string` -- sign prefix, 2dp, "%" suffix
- `formatNumber(value: number, dp?: number): string` -- Intl.NumberFormat en-GB
- `formatDate(dateStr: string): string` -- date-fns format "dd MMM yyyy"
- `formatDateShort(dateStr: string): string` -- date-fns format "dd/MM/yy"
- `daysToExpiry(expirationDate: string): number` -- date-fns differenceInDays from today
- `pnlClassName(value: number): string` -- returns "text-gain", "text-loss", or "text-muted-foreground"

`src/lib/transactions.ts` (import "server-only"):
- `TRANSACTIONS_PAGE_SIZE = 50`
- `TransactionFilters` interface: `{ symbol?: string; platform?: string; type?: string; dateFrom?: string; dateTo?: string }`
- `TransactionsPage` interface: `{ transactions: TransactionRecord[]; totalRows: number; hasMore: boolean }`
- `getTransactionsPage(offset?, filters?, sortField?, sortDir?): Promise<TransactionsPage>`:
  - Build NocoDB `where` clause from filters: symbol uses `like` (case-insensitive search), platform uses `eq`, type uses `eq`, dateFrom uses `gte,exactDate,`, dateTo uses `lte,exactDate,`
  - Combine conditions with `~and`
  - Sort via NocoDB sort param: sortDir "desc" -> `-${sortField}`, "asc" -> `${sortField}`
  - Default: sortField="date", sortDir="desc"
  - Call `listRecords<TransactionRecord>("transactions", { where, sort, limit: 50, offset })`
  - Return `{ transactions: result.list, totalRows: result.pageInfo.totalRows, hasMore: !result.pageInfo.isLastPage }`

`src/lib/options.ts` (import "server-only"):

Types to export:
- `OptionsStats`: `{ totalPremiumCollected, capitalGainsPnl, winRate, avgDaysHeld }` (all number)
- `RollChain`: `{ head: OptionRecord, legs: OptionRecord[], totalProfit: number, totalPremium: number }`
- `OptionsRow`: `{ option: OptionRecord, isChainHead: boolean, cumulativeProfit: number | null, cumulativePremium: number | null, subRows?: OptionsRow[] }`
- `LeapsDisplayRow`: extends OptionRecord with `currentPrice, intrinsicValue, extrinsicValue, valueLostPerMonth, costBasis, premiumFeePct, daysToExpiry, currentPnl` (all number | null except daysToExpiry: number)
- `MonthlyPremium`: `{ month: string, wheel: number, leaps: number }`

Functions to export:
- `inferRollChains(options: OptionRecord[]): { chains: RollChain[], standalone: OptionRecord[] }` -- Follow the algorithm from research: group by ticker, match "Rolled" status with close_date within 5 days of next opened date, same call_put. Build forward chains. Return chains and standalone (non-chained) options.
- `computeLeapsDisplay(opt: OptionRecord, currentPrice: number | null): LeapsDisplayRow` -- Compute intrinsicValue (Call: max(0, currentPrice - strike), Put: max(0, strike - currentPrice)), extrinsicValue (premium - intrinsicValue), costBasis (Call: strike + premium, Put: strike - premium), valueLostPerMonth ((extrinsicValue / daysOpen) * 30 * 100), premiumFeePct ((premium / strike) * 100), currentPnl ((currentPrice - costBasis) * qty * 100). Use date-fns differenceInDays for DTE and daysOpen.
- `buildPremiumByMonth(options: OptionRecord[], year: number): MonthlyPremium[]` -- Group options by month of `opened` date. For each month in Jan-Dec (or Jan to current month for current year), sum premium for Wheel (strategy_type === "Wheel") and LEAPS (strategy_type === "LEAPS") separately. Zero-fill months with no data. Return array of 12 MonthlyPremium objects.
- `buildOptionsRows(options: OptionRecord[]): OptionsRow[]` -- Call inferRollChains. For each chain, create a head OptionsRow with subRows for legs. For standalone, create OptionsRow without subRows. Set isChainHead, cumulativeProfit, cumulativePremium on chain heads.
- `getOptionsPageData(year?: number): Promise<OptionsPageData>` -- Fetch all options + symbols in parallel (fetchParallel). Build symbolPrices Map. Compute stats. Build premiumByMonth for the given year (default: current year). Return `{ options, stats, symbolPrices: Object.fromEntries(symbolPrices), premiumByMonth }`. Note: convert Map to plain object for serialisation across server/client boundary.
- `OptionsPageData`: `{ options: OptionRecord[], stats: OptionsStats, symbolPrices: Record<string, number>, premiumByMonth: MonthlyPremium[] }`

Stats computation:
- totalPremiumCollected: sum of `premium` where `buy_sell === "Sell"`
- capitalGainsPnl: sum of `profit` where `status === "Assigned"`
- winRate: (count of closed options with profit > 0) / (count of closed options) * 100. Closed = status in ["Closed", "Expired", "Assigned", "Rolled"]
- avgDaysHeld: mean of `days_held` for closed options (ignore nulls)

`src/actions/load-transactions.ts`:
- Mark as "use server" at top
- Export `loadMoreTransactions(offset: number, filters?: TransactionFilters, sortField?: string, sortDir?: "asc" | "desc"): Promise<TransactionsPage>`
- Calls `getTransactionsPage(offset, filters, sortField, sortDir)`

Run `pnpm typecheck` after creating all files.
  </action>
  <verify>`pnpm typecheck` passes. All exported types and functions are importable. `getTransactionsPage()` call with no arguments returns TransactionsPage shape. `getOptionsPageData()` returns OptionsPageData shape.</verify>
  <done>Data assembly layer complete: transactions.ts handles paginated server-side fetching with filtering/sorting, options.ts handles full options data assembly with roll chain inference and stats, format.ts provides shared formatting utilities, and the Server Action enables client-side infinite scroll.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes with no errors
2. `pnpm lint` passes
3. All shadcn components exist in src/components/ui/
4. All npm packages present in package.json dependencies
5. src/lib/transactions.ts imports from nocodb.ts and types.ts correctly
6. src/lib/options.ts imports from nocodb.ts and types.ts correctly
7. src/actions/load-transactions.ts has "use server" directive
8. src/lib/format.ts uses date-fns for date operations
</verification>

<success_criteria>
- All Phase 4 npm and shadcn dependencies installed without conflicts
- Data assembly functions type-check and handle all edge cases (null values, empty arrays, zero-fill months)
- Server Action properly re-exports the transaction fetching function
- No serialisation issues (all return types are plain objects, no Map/Set/Big.js crossing boundaries)
</success_criteria>

<output>
After completion, create `.planning/phases/04-transactions-options-display/04-01-SUMMARY.md`
</output>
