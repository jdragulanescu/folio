---
phase: 04-transactions-options-display
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/transactions/page.tsx
  - src/components/transactions/transactions-table.tsx
  - src/components/transactions/transactions-columns.tsx
  - src/components/transactions/transactions-filters.tsx
  - src/components/transactions/load-more-trigger.tsx
autonomous: true

must_haves:
  truths:
    - "Transaction history table renders with columns: Date, Symbol, Name, Type (badge), Price, Shares, Amount, Platform, EPS"
    - "Table is sortable by any column header click, triggering a server-side re-fetch from offset 0"
    - "Default sort is date descending"
    - "Scrolling to bottom loads 50 more transactions via Server Action until all are loaded"
    - "Symbol search filter debounces and triggers server-side re-fetch"
    - "Platform dropdown filters by broker, date range picker filters by date window, Buy/Sell toggle filters by type"
    - "Changing any filter resets to offset 0 and re-fetches from server"
    - "Buy badge is green, Sell badge is red"
  artifacts:
    - path: "src/app/transactions/page.tsx"
      provides: "Server Component fetching initial 50 transactions and rendering TransactionsTable"
    - path: "src/components/transactions/transactions-table.tsx"
      provides: "Client Component with TanStack Table, infinite scroll, filter/sort state management"
      min_lines: 80
    - path: "src/components/transactions/transactions-columns.tsx"
      provides: "TanStack Table column definitions with formatted cells and sort headers"
      exports: ["columns"]
    - path: "src/components/transactions/transactions-filters.tsx"
      provides: "Filter bar with symbol search, platform dropdown, date range picker, buy/sell toggle"
    - path: "src/components/transactions/load-more-trigger.tsx"
      provides: "Intersection Observer sentinel for infinite scroll"
  key_links:
    - from: "src/app/transactions/page.tsx"
      to: "src/lib/transactions.ts"
      via: "import getTransactionsPage"
      pattern: "import.*getTransactionsPage.*transactions"
    - from: "src/components/transactions/transactions-table.tsx"
      to: "src/actions/load-transactions.ts"
      via: "import loadMoreTransactions"
      pattern: "import.*loadMoreTransactions.*load-transactions"
    - from: "src/components/transactions/transactions-table.tsx"
      to: "src/components/transactions/transactions-columns.tsx"
      via: "import columns"
      pattern: "import.*columns.*transactions-columns"
---

<objective>
Build the complete transaction history page with sortable, filterable, paginated table using TanStack Table and infinite scroll.

Purpose: Covers requirements TRAN-01, TRAN-02, TRAN-03, TRAN-04. Users can browse ~960 transactions with progressive loading, sort by any column, and filter by symbol, platform, date range, and buy/sell type.

Output: 5 files forming the complete transactions page vertical slice.
</objective>

<execution_context>
@/Users/skylight/.claude/sky/workflows/execute-plan.md
@/Users/skylight/.claude/sky/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-transactions-options-display/04-RESEARCH.md
@.planning/phases/04-transactions-options-display/04-01-SUMMARY.md
@src/lib/types.ts
@src/lib/transactions.ts
@src/actions/load-transactions.ts
@src/lib/format.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create column definitions and filter bar components</name>
  <files>src/components/transactions/transactions-columns.tsx, src/components/transactions/transactions-filters.tsx, src/components/transactions/load-more-trigger.tsx</files>
  <action>
**`src/components/transactions/transactions-columns.tsx`:**
Define TanStack Table column definitions for TransactionRecord. This is NOT a client component (column defs are just objects). Import ColumnDef from @tanstack/react-table.

Columns (in order):
1. **date** -- header "Date", cell: `formatDate(row.original.date)`, sortable
2. **symbol** -- header "Symbol", cell: monospace font weight bold, sortable
3. **name** -- header "Name", cell: truncated to ~30 chars with tooltip if longer, sortable
4. **type** -- header "Type", cell: Badge component. Buy = `bg-gain/15 text-gain` outline badge, Sell = `bg-loss/15 text-loss` outline badge. Not sortable (use filter instead).
5. **price** -- header "Price", cell: `formatCurrency(row.original.price)`, right-aligned, sortable
6. **shares** -- header "Shares", cell: `formatNumber(row.original.shares, 0)`, right-aligned, sortable
7. **amount** -- header "Amount", cell: `formatCurrency(row.original.amount)`, right-aligned, sortable
8. **platform** -- header "Platform", cell: plain text, sortable
9. **eps** -- header "EPS", cell: `row.original.eps != null ? formatNumber(row.original.eps) : "â€”"`, right-aligned, sortable

Each sortable column header should show a sort indicator (ChevronUp/ChevronDown from lucide-react) based on sorting state. Use the Button component with variant="ghost" for clickable headers.

Import formatCurrency, formatNumber, formatDate from "@/lib/format". Import Badge from "@/components/ui/badge". Import Button from "@/components/ui/button". Import type TransactionRecord from "@/lib/types".

**`src/components/transactions/transactions-filters.tsx`** ("use client"):
Filter bar component that receives `filters` and `onFiltersChange` props.

Props interface:
```typescript
interface TransactionsFiltersProps {
  filters: TransactionFilters
  onFiltersChange: (filters: TransactionFilters) => void
}
```

Components in the filter bar (flex row, wrap on mobile, gap-3):
1. **Symbol search** -- Input component, placeholder "Search symbol...", w-[200px]. Debounce 300ms before calling onFiltersChange. Use a local state + setTimeout/clearTimeout pattern.
2. **Platform dropdown** -- Select component. Options: "All Platforms" (value ""), then all brokers from `[...BROKERS.active, ...BROKERS.archived]`. w-[160px].
3. **Buy/Sell toggle** -- ToggleGroup type="single". Items: "All" (value ""), "Buy" (value "Buy"), "Sell" (value "Sell").
4. **Date range picker** -- Two date inputs using shadcn Calendar + Popover composition. "From" and "To" buttons that open calendar popovers. Display selected date in the button text. Use date-fns format for display and "yyyy-MM-dd" for the filter value. Place a CalendarIcon from lucide-react in each button.

Import BROKERS from "@/lib/types", Input, Select/SelectTrigger/SelectContent/SelectItem, ToggleGroup/ToggleGroupItem, Popover/PopoverTrigger/PopoverContent, Calendar, Button.

**`src/components/transactions/load-more-trigger.tsx`** ("use client"):
Intersection Observer sentinel component.

Props: `{ onLoadMore: () => void, hasMore: boolean, isLoading: boolean }`

Implementation:
- useRef for the sentinel div
- useEffect with IntersectionObserver (threshold: 0.1)
- When entry.isIntersecting and hasMore and not isLoading, call onLoadMore
- Include onLoadMore, hasMore, isLoading in dependency array
- Clean up observer on unmount
- Render: if !hasMore, return null. Otherwise render a div with ref. If isLoading, show a Skeleton loader (h-8 w-32 centered).

Import Skeleton from "@/components/ui/skeleton".
  </action>
  <verify>`pnpm typecheck` passes. All three files exist and export their components/columns.</verify>
  <done>Column definitions render all 9 columns with formatting. Filter bar provides symbol search (debounced), platform dropdown, date range picker, and buy/sell toggle. Load-more trigger fires Intersection Observer callback.</done>
</task>

<task type="auto">
  <name>Task 2: Create transactions table and page</name>
  <files>src/components/transactions/transactions-table.tsx, src/app/transactions/page.tsx</files>
  <action>
**`src/components/transactions/transactions-table.tsx`** ("use client"):

This is the main orchestrator component. It manages:
- Transaction data array (starts with initialData, grows via infinite scroll)
- Filter state (TransactionFilters)
- Sort state (field + direction)
- Loading state
- TanStack Table instance

Props:
```typescript
interface TransactionsTableProps {
  initialData: TransactionsPage
}
```

State management:
- `transactions` state: starts with `initialData.transactions`
- `totalRows` state: starts with `initialData.totalRows`
- `hasMore` state: starts with `initialData.hasMore`
- `filters` state: `TransactionFilters` default all empty
- `sorting` state: TanStack SortingState, default `[{ id: "date", desc: true }]`
- `isLoading` ref (useRef<boolean>) to prevent double-fetches

**Sort handling:**
When sorting changes (via onSortingChange from TanStack Table):
1. Update sorting state
2. Reset transactions to []
3. Set hasMore to true
4. Fetch from offset 0 with new sort params via `loadMoreTransactions(0, filters, sortField, sortDir)`
5. Replace transactions with result.transactions
6. **Update totalRows: `setTotalRows(result.totalRows)`** -- critical to keep the displayed count accurate after re-fetch

Map TanStack SortingState to NocoDB sort params: `sorting[0]?.id` for field, `sorting[0]?.desc` for direction.

**Filter handling:**
When filters change (from TransactionsFilters onFiltersChange):
1. Update filters state
2. Reset transactions to []
3. Set hasMore to true
4. Fetch from offset 0 with new filters via `loadMoreTransactions(0, newFilters, sortField, sortDir)`
5. Replace transactions with result.transactions
6. **Update totalRows: `setTotalRows(result.totalRows)`** -- filters change the matching count, so totalRows must reflect the filtered total

**Load more handling:**
When LoadMoreTrigger fires:
1. If isLoading.current, return
2. Set isLoading.current = true
3. Call `loadMoreTransactions(transactions.length, filters, sortField, sortDir)`
4. Append result.transactions to existing transactions
5. Update totalRows, hasMore
6. Set isLoading.current = false

**TanStack Table setup:**
```typescript
const table = useReactTable({
  data: transactions,
  columns,
  state: { sorting },
  onSortingChange: setSorting,  // This triggers the sort handler
  getCoreRowModel: getCoreRowModel(),
  manualSorting: true,          // CRITICAL: sorting is server-side
  manualFiltering: true,        // CRITICAL: filtering is server-side
})
```

Note: `manualSorting: true` prevents TanStack from sorting client-side. The actual sort happens via the Server Action.

**Render layout:**
```
<div className="space-y-4">
  <div className="flex items-center justify-between">
    <h1 className="text-2xl font-bold">Transactions</h1>
    <p className="text-sm text-muted-foreground">{totalRows} transactions</p>
  </div>
  <TransactionsFilters filters={filters} onFiltersChange={handleFiltersChange} />
  <div className="rounded-md border">
    <Table>
      <TableHeader>
        {table.getHeaderGroups().map(...)}
      </TableHeader>
      <TableBody>
        {table.getRowModel().rows.length ? (
          table.getRowModel().rows.map(row => (
            <TableRow key={row.id}>
              {row.getVisibleCells().map(cell => (
                <TableCell key={cell.id}>
                  {flexRender(cell.column.columnDef.cell, cell.getContext())}
                </TableCell>
              ))}
            </TableRow>
          ))
        ) : (
          <TableRow>
            <TableCell colSpan={columns.length} className="h-24 text-center">
              {isLoading.current ? "Loading..." : "No transactions found."}
            </TableCell>
          </TableRow>
        )}
      </TableBody>
    </Table>
  </div>
  <LoadMoreTrigger onLoadMore={handleLoadMore} hasMore={hasMore} isLoading={isLoadingState} />
</div>
```

Use `isLoadingState` (a regular useState boolean) for the UI display, and `isLoading` ref for preventing double-fetches.

Import Table/TableHeader/TableBody/TableRow/TableHead/TableCell from "@/components/ui/table". Import flexRender from "@tanstack/react-table".

**`src/app/transactions/page.tsx`** (Server Component):
Replace the placeholder. Import getTransactionsPage from "@/lib/transactions". Import TransactionsTable from "@/components/transactions/transactions-table".

```typescript
import { getTransactionsPage } from "@/lib/transactions"
import { TransactionsTable } from "@/components/transactions/transactions-table"

export default async function TransactionsPage() {
  const initialData = await getTransactionsPage()
  return <TransactionsTable initialData={initialData} />
}
```

The page is intentionally minimal -- all layout is in the client component.

Run `pnpm typecheck && pnpm lint` after creating both files.
  </action>
  <verify>`pnpm typecheck` passes. `pnpm lint` passes. Navigate to /transactions in browser -- table renders with initial 50 transactions, sorted by date descending.</verify>
  <done>Transaction history page is complete: table renders all 9 columns with formatting, sorting triggers server re-fetch, filters narrow results via server-side NocoDB queries, infinite scroll loads 50 more per trigger until all ~960 are loaded.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. /transactions page renders without errors
4. Table shows 9 columns: Date, Symbol, Name, Type (badge), Price, Shares, Amount, Platform, EPS
5. Clicking column headers sorts (server-side re-fetch)
6. Default sort is date descending
7. Scrolling loads more transactions (50 at a time)
8. Symbol search debounces and filters
9. Platform dropdown filters
10. Buy/Sell toggle filters
11. Date range picker filters
</verification>

<success_criteria>
- All TRAN-01, TRAN-02, TRAN-03, TRAN-04 requirements met
- No client-side sorting bugs (manualSorting: true)
- No stale closure bugs in Intersection Observer (dependencies in useEffect)
- Debounced symbol search prevents excessive NocoDB requests
- Empty state displays when no transactions match filters
</success_criteria>

<output>
After completion, create `.planning/phases/04-transactions-options-display/04-02-SUMMARY.md`
</output>
