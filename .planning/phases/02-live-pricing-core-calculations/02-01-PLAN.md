---
phase: 02-live-pricing-core-calculations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/fmp.ts
  - src/lib/fmp-types.ts
  - src/lib/nocodb.ts
  - src/lib/types.ts
autonomous: true

must_haves:
  truths:
    - "FMP client can fetch batch quotes for multiple symbols in a single request"
    - "FMP client can fetch USD/GBP forex rate"
    - "FMP API key is never exposed to client bundles (server-only guard)"
    - "NocoDB client can bulk-create and bulk-update records in a single API call"
    - "SymbolRecord type includes all extended fundamental metric fields"
  artifacts:
    - path: "src/lib/fmp.ts"
      provides: "FMP API client with batch quotes, forex, and key-metrics-ttm"
      exports: ["fetchBatchQuotes", "fetchForexRate", "fetchKeyMetricsTTM"]
    - path: "src/lib/fmp-types.ts"
      provides: "TypeScript types for all FMP API response shapes"
      exports: ["FMPQuote", "FMPForexQuote", "FMPKeyMetricsTTM"]
    - path: "src/lib/nocodb.ts"
      provides: "Extended NocoDB client with bulk operations"
      exports: ["createRecords", "updateRecords"]
    - path: "src/lib/types.ts"
      provides: "Extended SymbolRecord with fundamental metrics fields"
      contains: "forward_pe"
  key_links:
    - from: "src/lib/fmp.ts"
      to: "process.env.FMP_API_KEY"
      via: "server-only import guard"
      pattern: 'import "server-only"'
    - from: "src/lib/fmp.ts"
      to: "src/lib/fmp-types.ts"
      via: "type imports for return types"
      pattern: "import.*FMPQuote.*from.*fmp-types"
    - from: "src/lib/nocodb.ts"
      to: "src/lib/types.ts"
      via: "TableName type for bulk operations"
      pattern: "createRecords.*TableName"
---

<objective>
Build the FMP API client library and extend the NocoDB client with bulk operations for the price sync pipeline.

Purpose: This plan creates the server-side data layer that Phase 2's sync pipeline depends on -- fetching prices from FMP and writing them efficiently to NocoDB. Without this, the sync route handler (Plan 02) has nothing to call.

Output: Four files -- FMP client (`fmp.ts`), FMP types (`fmp-types.ts`), extended NocoDB client with `createRecords`/`updateRecords`, and extended `SymbolRecord` with fundamental metric fields.
</objective>

<execution_context>
@/Users/skylight/.claude/sky/workflows/execute-plan.md
@/Users/skylight/.claude/sky/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-live-pricing-core-calculations/02-RESEARCH.md

@src/lib/nocodb.ts
@src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FMP type definitions and client library</name>
  <files>src/lib/fmp-types.ts, src/lib/fmp.ts</files>
  <action>
Install big.js and swr (needed by later plans but install now to avoid duplication):
```bash
pnpm add big.js swr && pnpm add -D @types/big.js
```

Create `src/lib/fmp-types.ts` with TypeScript interfaces for all FMP API response shapes:

1. **FMPQuote** -- response from `GET /api/v3/quote/{symbols}`:
   - symbol, name, price, changesPercentage, change, dayLow, dayHigh, yearHigh, yearLow
   - marketCap, priceAvg50, priceAvg200, volume, avgVolume, exchange, open, previousClose
   - eps, pe, earningsAnnouncement (string | null), sharesOutstanding, timestamp

2. **FMPForexQuote** -- response from `GET /api/v3/fx/{pair}`:
   - ticker, bid, ask, open, low, high, changes, date

3. **FMPKeyMetricsTTM** -- response from `GET /api/v3/key-metrics-ttm/{symbol}`:
   - All fields nullable (free tier may restrict access)
   - Include: peRatioTTM, pegRatioTTM, dividendYieldTTM, revenuePerShareTTM, netIncomePerShareTTM, operatingCashFlowPerShareTTM, freeCashFlowPerShareTTM, cashPerShareTTM, bookValuePerShareTTM, debtToEquityTTM, currentRatioTTM, returnOnEquityTTM, returnOnAssetsTTM

Create `src/lib/fmp.ts` with:
- `import "server-only"` at top (same pattern as nocodb.ts)
- `FMP_BASE = "https://financialmodelingprep.com"` and `API_KEY = process.env.FMP_API_KEY!`
- Internal `fmpFetch<T>(path)` helper that appends `?apikey=` or `&apikey=`, uses `cache: "no-store"`, throws on non-ok with status + body text
- `fetchBatchQuotes(symbols: string[]): Promise<FMPQuote[]>` -- joins symbols with comma, calls `/api/v3/quote/{symbolStr}`. Batch in groups of 30 symbols max per call (URL length safety). If multiple batches needed, fetch sequentially and concatenate results.
- `fetchForexRate(pair: string = "USDGBP"): Promise<FMPForexQuote>` -- calls `/api/v3/fx/{pair}`, returns the first element of the response array
- `fetchKeyMetricsTTM(symbol: string): Promise<FMPKeyMetricsTTM | null>` -- calls `/api/v3/key-metrics-ttm/{symbol}`, returns first element or null if 403/empty (graceful fallback for free tier restrictions). Wrap in try/catch, return null on failure.

All functions must use proper TypeScript types from fmp-types.ts. No `any` types.
  </action>
  <verify>
Run `pnpm typecheck` -- no errors related to fmp.ts or fmp-types.ts.
Verify `server-only` import exists in fmp.ts.
Verify no `any` types in either file.
  </verify>
  <done>
FMP client can fetch batch quotes (30 per request), forex rate, and key metrics with graceful fallback. API key protected by server-only guard.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend NocoDB client with bulk operations and SymbolRecord with fundamentals</name>
  <files>src/lib/nocodb.ts, src/lib/types.ts</files>
  <action>
Add two new exported functions to `src/lib/nocodb.ts`:

1. **`createRecords<T>(table: TableName, records: Partial<T>[]): Promise<T[]>`**
   - POST to `/api/v2/tables/${tableId}/records` with JSON array body
   - Uses existing `nocodbFetch` helper
   - Handle empty array input (return [] immediately, skip API call)

2. **`updateRecords<T>(table: TableName, records: Array<Partial<T> & { Id: number }>): Promise<T[]>`**
   - PATCH to `/api/v2/tables/${tableId}/records` with JSON array body
   - Each record in the array must include `Id` field (NocoDB v2 requirement)
   - Batch in groups of 50 records per request (safe NocoDB batch size). If >50 records, split into chunks, send sequentially, concatenate results.
   - Handle empty array input (return [] immediately)

Add to `src/lib/types.ts` -- extend `SymbolRecord` with new nullable fields for extended fundamental metrics:
- `forward_pe: number | null`
- `peg_ratio: number | null`
- `dividend_yield_ttm: number | null` (FMP's TTM dividend yield, separate from basic dividend_yield)
- `revenue_per_share: number | null`
- `roe: number | null`
- `roa: number | null`
- `debt_to_equity: number | null`
- `free_cash_flow_per_share: number | null`
- `book_value_per_share: number | null`
- `current_ratio: number | null`
- `price_avg_50: number | null`
- `price_avg_200: number | null`
- `last_fundamentals_update: string | null`

Also add a `currency` field to SymbolRecord: `currency: "USD" | "GBP" | null` -- needed for FX conversion in aggregations.

IMPORTANT: These are type definitions only. The corresponding NocoDB columns should already exist from migration or will be added via NocoDB UI. The code just needs the types to compile.
  </action>
  <verify>
Run `pnpm typecheck` -- no errors.
Verify `createRecords` and `updateRecords` are exported from nocodb.ts.
Verify `SymbolRecord` includes `forward_pe`, `peg_ratio`, `currency` fields.
  </verify>
  <done>
NocoDB client supports bulk create (POST array) and bulk update (PATCH array with 50-record batching). SymbolRecord type covers all extended fundamental metrics that FMP may provide.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes with zero errors
2. `pnpm lint` passes
3. `fmp.ts` imports `server-only` (grep for the import)
4. `fmp.ts` exports `fetchBatchQuotes`, `fetchForexRate`, `fetchKeyMetricsTTM`
5. `nocodb.ts` exports `createRecords`, `updateRecords`
6. No `any` types in new code
7. No floating-point arithmetic in any new code (Big.js not used here but verify no accidental math)
</verification>

<success_criteria>
- FMP client library compiles and exports three fetch functions with correct TypeScript types
- NocoDB client has bulk operations that batch in groups of 50 for updates
- SymbolRecord type covers all FMP quote fields plus extended fundamental metrics
- All server-side modules are protected from client-side import
</success_criteria>

<output>
After completion, create `.planning/phases/02-live-pricing-core-calculations/02-01-SUMMARY.md`
</output>
