---
phase: 03-portfolio-overview
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/portfolio/summary-cards.tsx
  - src/components/portfolio/allocation-charts.tsx
  - src/components/portfolio/top-movers.tsx
  - src/components/portfolio/broker-breakdown.tsx
  - src/app/page.tsx
autonomous: true

must_haves:
  truths:
    - "Summary cards display total portfolio value, total P&L (amount and %), day change, total deposited, and options premium collected"
    - "Sector allocation donut chart shows portfolio breakdown by sector with hover tooltips"
    - "Strategy allocation donut chart shows portfolio breakdown by investment strategy"
    - "Top 5 gainers and top 5 losers are displayed with symbol, value, and change metric"
    - "Per-broker breakdown is accessible via a drill-down action (not cluttering the main dashboard)"
    - "Small allocation slices (<3%) are grouped into an 'Other' slice in donut charts"
  artifacts:
    - path: "src/components/portfolio/summary-cards.tsx"
      provides: "Five summary metric cards for portfolio overview"
      exports: ["SummaryCards"]
    - path: "src/components/portfolio/allocation-charts.tsx"
      provides: "Sector and strategy donut charts using Recharts via shadcn Chart"
      exports: ["AllocationCharts"]
    - path: "src/components/portfolio/top-movers.tsx"
      provides: "Top 5 gainers and top 5 losers display"
      exports: ["TopMovers"]
    - path: "src/components/portfolio/broker-breakdown.tsx"
      provides: "Per-broker P&L and allocation breakdown (PORT-10)"
      exports: ["BrokerBreakdown"]
  key_links:
    - from: "src/app/page.tsx"
      to: "src/components/portfolio/summary-cards.tsx"
      via: "import SummaryCards and render with data prop"
      pattern: "<SummaryCards"
    - from: "src/app/page.tsx"
      to: "src/components/portfolio/allocation-charts.tsx"
      via: "import AllocationCharts and render with holdings prop"
      pattern: "<AllocationCharts"
    - from: "src/app/page.tsx"
      to: "src/components/portfolio/top-movers.tsx"
      via: "import TopMovers and render with holdings prop"
      pattern: "<TopMovers"
    - from: "src/components/portfolio/allocation-charts.tsx"
      to: "src/components/ui/chart.tsx"
      via: "import ChartContainer, ChartTooltip, ChartConfig"
      pattern: "import.*ChartContainer.*chart"
---

<objective>
Build the summary metric cards, sector/strategy allocation donut charts, per-broker breakdown, and top movers components, then wire everything into the portfolio page.

Purpose: These components complete the portfolio overview dashboard (PORT-04, PORT-05, PORT-06, PORT-09, PORT-10). Summary cards give an at-a-glance portfolio health view. Donut charts show allocation breakdowns. Top movers highlight the day's best and worst performers. Broker breakdown gives per-platform visibility.

Output: `summary-cards.tsx`, `allocation-charts.tsx`, `top-movers.tsx`, `broker-breakdown.tsx`, and updated `page.tsx` with all components wired.
</objective>

<execution_context>
@/Users/skylight/.claude/sky/workflows/execute-plan.md
@/Users/skylight/.claude/sky/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-portfolio-overview/03-01-SUMMARY.md
@src/lib/portfolio.ts
@src/lib/format.ts
@src/components/ui/card.tsx
@src/components/ui/chart.tsx
@src/components/ui/badge.tsx
@src/styles/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create summary cards and allocation donut charts</name>
  <files>src/components/portfolio/summary-cards.tsx, src/components/portfolio/allocation-charts.tsx</files>
  <action>
Create the summary metric cards and the sector/strategy allocation donut charts.

**File 1: `src/components/portfolio/summary-cards.tsx`**

"use client" directive. Client component receiving portfolio data as props.

Props: `{ data: PortfolioData }` (import `PortfolioData` from `@/lib/portfolio`).

Display 5 metrics using shadcn `Card` components:

**Card 1: Total Portfolio Value** (primary/hero card)
- Large formatted value: `formatCurrency(data.totals.totalMarketValue)`
- This is the most prominent card -- use larger text size (e.g., `text-3xl font-bold`)
- Subtitle: "Total Portfolio Value"

**Card 2: Total P&L**
- Value: `formatCurrency(data.totals.totalUnrealisedPnl)` with `pnlClassName` colour
- Subtitle showing percentage: total unrealised P&L as % of total cost (`totalUnrealisedPnl / totalCost * 100`), also coloured
- Label: "Unrealised P&L"

**Card 3: Day Change**
- Value: `formatCurrency(data.dayChange)` with `pnlClassName` colour
- Subtitle: `formatPercent(data.dayChangePct)` also coloured
- Label: "Day Change"

**Card 4: Total Deposited**
- Value: `formatCurrency(data.totalDeposited)`
- Label: "Total Deposited"
- No colour (neutral metric)

**Card 5: Options Premium**
- Value: `formatCurrency(data.optionsPremium)`
- Label: "Options Premium Collected"
- Colour: green (positive income metric) using `text-gain`

Layout: Use a responsive grid `grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4`. The hero card (Total Portfolio Value) could span 2 columns on mobile for prominence: `col-span-2 md:col-span-1`.

Card internal structure using shadcn Card anatomy:
```tsx
<Card>
  <CardHeader className="pb-2">
    <CardDescription>{label}</CardDescription>
    <CardTitle className="text-2xl">{formattedValue}</CardTitle>
  </CardHeader>
  <CardContent>
    <p className="text-xs text-muted-foreground">{subtitle}</p>
  </CardContent>
</Card>
```

Adjust the exact layout and sizing for visual balance. The user wants "amazing looking but also practical."

**File 2: `src/components/portfolio/allocation-charts.tsx`**

"use client" directive. Client component for sector and strategy donut charts.

Props: `{ holdings: DisplayHolding[] }` (import from `@/lib/portfolio`).

This component renders TWO donut charts side by side (or stacked on narrow screens):
1. **Sector Allocation** -- groups holdings by `sector` field
2. **Strategy Allocation** -- groups holdings by `strategy` field

For each chart:

1. **Aggregate data**: Group holdings by the field (sector or strategy). For each group, sum `marketValue` to get the group's total market value. Calculate percentage as `(groupTotal / totalMarketValue) * 100`.

2. **Handle small slices**: Any group with allocation < 3% gets merged into an "Other" group. Handle null sectors/strategies by labelling them "Unassigned".

3. **Colour mapping**: Use the CSS custom properties `--chart-1` through `--chart-5` for the first 5 slices. For additional slices, cycle through a generated palette or use HSL variations. Define a `ChartConfig` object mapping each slice name to a label and colour:
```typescript
const chartConfig: ChartConfig = {
  technology: { label: "Technology", color: "var(--chart-1)" },
  healthcare: { label: "Healthcare", color: "var(--chart-2)" },
  // ... etc
}
```

4. **Chart rendering**: Use the shadcn Chart pattern:
```tsx
<ChartContainer config={chartConfig} className="mx-auto aspect-square max-h-[250px]">
  <PieChart>
    <ChartTooltip cursor={false} content={<ChartTooltipContent hideLabel />} />
    <Pie data={chartData} dataKey="value" nameKey="name" innerRadius={60} strokeWidth={5}>
      <Label content={...} />  {/* Center label showing total market value */}
    </Pie>
  </PieChart>
</ChartContainer>
```

5. **Center label**: Show the total market value (formatted compact) in the donut centre for the sector chart, and the number of strategies for the strategy chart. Use the Recharts `Label` component with custom `content` render prop (pattern from research: `viewBox.cx`, `viewBox.cy` for positioning).

6. **Chart data format**: Each data point: `{ name: string, value: number, fill: string }`. The `fill` references the CSS variable via `var(--color-{key})` where the key matches the ChartConfig.

Wrap each chart in a `Card` with `CardHeader` (title: "Sector Allocation" / "Strategy Allocation") and `CardContent` (the chart).

Layout: Two charts in a `grid grid-cols-1 gap-4` within the sidebar column. Each chart takes full width of the sidebar.

Import: `PieChart`, `Pie`, `Label` from `recharts`. `ChartContainer`, `ChartTooltip`, `ChartTooltipContent` from `@/components/ui/chart`. `Card`, `CardHeader`, `CardTitle`, `CardContent` from `@/components/ui/card`.
  </action>
  <verify>
`pnpm typecheck` passes. Both files exist. `summary-cards.tsx` exports `SummaryCards`. `allocation-charts.tsx` exports `AllocationCharts`. The chart component imports from `recharts` and `@/components/ui/chart`.
  </verify>
  <done>Summary cards display all 5 required metrics with proper formatting and gain/loss colouring. Sector and strategy donut charts render with hover tooltips, center labels, and small-slice grouping into "Other".</done>
</task>

<task type="auto">
  <name>Task 2: Create top movers, broker breakdown, and wire all components into page</name>
  <files>src/components/portfolio/top-movers.tsx, src/components/portfolio/broker-breakdown.tsx, src/app/page.tsx</files>
  <action>
Create the top movers component, broker breakdown component, and wire everything into the portfolio page.

**File 1: `src/components/portfolio/top-movers.tsx`**

"use client" directive. Shows top 5 gainers and top 5 losers.

Props: `{ holdings: DisplayHolding[] }`.

The component shows TWO lists: gainers and losers.

Metric choice: Use **day change % (`changePct`)** as the primary metric for movers. This is the most actionable daily information. Filter out holdings where `changePct` is null before sorting.

**Gainers**: Sort holdings by `changePct` descending, take top 5.
**Losers**: Sort holdings by `changePct` ascending, take top 5.

Display each mover as a compact row within a Card:
```
AAPL    +3.45%
MSFT    +2.12%
NVDA    +1.87%
```

Each row shows:
- Symbol (bold, left-aligned) -- clickable Link to `/symbol/{symbol}`
- Day change percentage (right-aligned) with `pnlClassName` colour
- Optionally show `formatCurrency(marketValue)` as muted secondary text below the symbol for context

Layout: Two Card components side-by-side or stacked:
- Card 1: "Top Gainers" with green accent (using `border-gain` or a subtle green tint)
- Card 2: "Top Losers" with red accent

Use `Card`, `CardHeader`, `CardTitle`, `CardContent` from shadcn. Each mover item rendered as a flex row.

Handle edge cases:
- Fewer than 5 holdings with positive change: show as many gainers as exist
- All holdings have null changePct: show "No data available"
- Zero holdings: show empty state

**File 2: `src/components/portfolio/broker-breakdown.tsx`**

"use client" directive. Per-broker P&L and allocation breakdown (PORT-10).

Props: `{ holdings: DisplayHolding[] }`.

Per CONTEXT.md, this is "NOT on main dashboard -- drill-down only." Implement as a collapsible section using a simple expand/collapse pattern (a Button that toggles visibility of the content, or use the existing Sheet component).

Recommended approach: a `Card` with a `CardHeader` containing a clickable "View Broker Breakdown" button. When clicked, the `CardContent` expands to show:

1. **Broker summary table**: A simple table showing for each broker:
   - Broker name
   - Number of holdings
   - Total market value (`formatCurrency`)
   - Total P&L (`formatCurrency`, coloured)
   - Weight percentage (broker's total value / portfolio total value)

2. **Broker allocation donut chart**: A small donut chart showing allocation by broker (same pattern as the sector/strategy charts but grouped by `platform`).

Aggregate data: Group holdings by `platform` field. For each broker, sum `marketValue` and `unrealisedPnl`.

Use `useState` for the expanded/collapsed state. Default to collapsed.

Handle null platform: group as "Unknown".

**File 3: `src/app/page.tsx`**

Update the portfolio page to wire in ALL remaining components from plans 03-02 and 03-03.

The final page structure should be:

```tsx
import { getPortfolioData } from "@/lib/portfolio"
import { HoldingsTable } from "@/components/portfolio/holdings-table"
import { SummaryCards } from "@/components/portfolio/summary-cards"
import { AllocationCharts } from "@/components/portfolio/allocation-charts"
import { TopMovers } from "@/components/portfolio/top-movers"
import { BrokerBreakdown } from "@/components/portfolio/broker-breakdown"

export default async function PortfolioPage() {
  const data = await getPortfolioData()

  return (
    <div className="space-y-6">
      {/* Summary cards - full width */}
      <SummaryCards data={data} />

      {/* Main content grid */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Left: Holdings table (2/3 width) */}
        <div className="lg:col-span-2 space-y-6">
          <HoldingsTable holdings={data.holdings} />
          <BrokerBreakdown holdings={data.holdings} />
        </div>

        {/* Right: Charts and movers (1/3 width) */}
        <div className="space-y-6">
          <AllocationCharts holdings={data.holdings} />
          <TopMovers holdings={data.holdings} />
        </div>
      </div>
    </div>
  )
}
```

Key points:
- `SummaryCards` receives full `PortfolioData` (needs totals + dayChange + totalDeposited + optionsPremium)
- `HoldingsTable`, `AllocationCharts`, `TopMovers`, and `BrokerBreakdown` receive `holdings` array
- Page remains an async Server Component (no "use client")
- Remove all placeholder sections from plan 03-01
- Keep the page heading minimal or remove it entirely (the summary cards serve as the page identity)

Ensure the layout looks clean and professional. The grid should collapse gracefully on mobile (single column stack).
  </action>
  <verify>
`pnpm typecheck` passes. `pnpm lint` passes. All four component files exist in `src/components/portfolio/`. `page.tsx` imports and renders all components: `SummaryCards`, `HoldingsTable`, `AllocationCharts`, `TopMovers`, `BrokerBreakdown`. No "use client" on `page.tsx`.
  </verify>
  <done>Top movers display top 5 gainers/losers by day change %. Broker breakdown accessible as expandable drill-down. All components wired into the portfolio page with responsive grid layout. Full dashboard functional.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes with zero errors
2. `pnpm lint` passes
3. Summary cards show 5 metrics: total value, P&L (amount + %), day change, total deposited, options premium
4. Sector donut chart groups holdings by sector with <3% slices merged to "Other"
5. Strategy donut chart groups holdings by strategy with same grouping logic
6. Donut charts have hover tooltips and center labels
7. Top 5 gainers sorted by changePct descending, top 5 losers ascending
8. Broker breakdown hidden by default, expandable on click
9. All components wired into page.tsx with correct props
10. Page layout: summary cards (full width) -> table (2/3) + charts/movers (1/3)
11. Mobile-responsive: single column stack on narrow screens
</verification>

<success_criteria>
- PORT-04: Summary cards display all 5 required metrics
- PORT-05: Sector allocation donut chart visible
- PORT-06: Strategy allocation donut chart visible
- PORT-09: Top 5 gainers and top 5 losers displayed
- PORT-10: Per-broker breakdown accessible (drill-down)
- Layout is visually appealing with responsive grid
- All gain/loss values coloured green/red consistently
</success_criteria>

<output>
After completion, create `.planning/phases/03-portfolio-overview/03-03-SUMMARY.md`
</output>
