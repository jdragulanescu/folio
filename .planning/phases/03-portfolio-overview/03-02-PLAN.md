---
phase: 03-portfolio-overview
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/portfolio/holdings-columns.tsx
  - src/components/portfolio/holdings-table.tsx
  - src/hooks/use-column-visibility.ts
  - src/app/symbol/[symbol]/page.tsx
  - src/app/page.tsx
autonomous: true

must_haves:
  truths:
    - "The holdings table displays all required columns and is sortable by clicking any column header"
    - "Typing in the search input filters holdings by symbol (partial match)"
    - "Column visibility can be toggled via a dropdown menu and preferences persist across page reloads"
    - "Default sort is weight descending with ~6 core columns visible"
    - "P&L and day change values are coloured green (positive) or red (negative)"
    - "Clicking a symbol row navigates to /symbol/[symbol] which shows position summary, fundamentals, and transaction history"
  artifacts:
    - path: "src/components/portfolio/holdings-columns.tsx"
      provides: "TanStack Table column definitions for holdings"
      exports: ["columns"]
    - path: "src/components/portfolio/holdings-table.tsx"
      provides: "Interactive holdings table with sort, filter, column visibility"
      exports: ["HoldingsTable"]
    - path: "src/hooks/use-column-visibility.ts"
      provides: "localStorage-backed column visibility persistence"
      exports: ["useColumnVisibility"]
    - path: "src/app/symbol/[symbol]/page.tsx"
      provides: "Symbol detail page with position summary, fundamentals, and transactions"
  key_links:
    - from: "src/components/portfolio/holdings-table.tsx"
      to: "src/components/portfolio/holdings-columns.tsx"
      via: "import columns"
      pattern: "import.*columns.*holdings-columns"
    - from: "src/components/portfolio/holdings-table.tsx"
      to: "src/hooks/use-column-visibility.ts"
      via: "import useColumnVisibility"
      pattern: "import.*useColumnVisibility"
    - from: "src/app/page.tsx"
      to: "src/components/portfolio/holdings-table.tsx"
      via: "import HoldingsTable and render with holdings prop"
      pattern: "<HoldingsTable"
    - from: "src/components/portfolio/holdings-table.tsx"
      to: "/symbol/[symbol]"
      via: "router.push or Link on row click"
      pattern: "symbol.*link|router.*push.*symbol"
---

<objective>
Build the interactive holdings table with TanStack Table (sortable, filterable, column visibility) and the symbol detail drill-down page.

Purpose: The holdings table is the centrepiece of the portfolio dashboard (PORT-01, PORT-02, PORT-03, PORT-12). It must show all required financial data columns with sort-by-click, symbol search filtering, and column visibility toggling. Clicking a row navigates to a dedicated symbol detail page.

Output: `holdings-columns.tsx` (column definitions), `holdings-table.tsx` (table component), `use-column-visibility.ts` (persistence hook), `symbol/[symbol]/page.tsx` (detail page), updated `page.tsx` (wiring).
</objective>

<execution_context>
@/Users/skylight/.claude/sky/workflows/execute-plan.md
@/Users/skylight/.claude/sky/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-portfolio-overview/03-01-SUMMARY.md
@src/lib/portfolio.ts
@src/lib/format.ts
@src/lib/types.ts
@src/lib/calculations.ts
@src/lib/nocodb.ts
@src/components/ui/table.tsx
@src/components/ui/dropdown-menu.tsx
@src/components/ui/badge.tsx
@src/components/ui/input.tsx
@src/components/ui/button.tsx
@src/styles/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create column definitions and holdings table component</name>
  <files>src/components/portfolio/holdings-columns.tsx, src/components/portfolio/holdings-table.tsx, src/hooks/use-column-visibility.ts</files>
  <action>
Create the TanStack Table-based holdings table with all required interactivity.

**File 1: `src/hooks/use-column-visibility.ts`**

Client-side hook for persisting column visibility state in localStorage.

- Storage key: `"folio-holdings-columns"`
- Default visibility state: core columns visible, optional columns hidden
  - **Visible by default (core ~6):** `symbol`, `currentPrice`, `marketValue`, `unrealisedPnl`, `changePct`, `weight`
  - **Hidden by default (toggle-able):** `name`, `shares`, `avgCost`, `totalCost`, `realisedPnl`, `unrealisedPnlPct`, `sector`, `strategy`, `platform`
- On mount, read from localStorage. If stored value exists and parses as valid JSON, use it. Otherwise use defaults.
- When visibility changes, persist to localStorage immediately.
- Return `[visibility, setVisibility]` tuple typed as `[VisibilityState, (updater: VisibilityState | ((prev: VisibilityState) => VisibilityState)) => void]`.
- Handle the TanStack Table `onColumnVisibilityChange` callback shape (it passes either a VisibilityState or an updater function).

**File 2: `src/components/portfolio/holdings-columns.tsx`**

"use client" directive. Column definitions array for TanStack Table.

Define columns for `DisplayHolding` (imported from `@/lib/portfolio`):

| Column ID | Header Label | Cell Formatting | Sort | Notes |
|-----------|-------------|-----------------|------|-------|
| `symbol` | Symbol | Bold text, clickable link to `/symbol/{symbol}` | String sort | Always visible |
| `name` | Name | Plain text | String sort | Hidden by default |
| `shares` | Shares | `formatNumber(value, 4)` for fractional shares | Numeric sort | Hidden by default |
| `avgCost` | Avg Cost | `formatCurrency(value)` | Numeric sort | Hidden by default |
| `totalCost` | Total Cost | `formatCurrency(value)` | Numeric sort | Hidden by default |
| `currentPrice` | Price | `formatCurrency(value)` | Numeric sort | Core visible |
| `marketValue` | Market Value | `formatCurrency(value)` | Numeric sort | Core visible |
| `unrealisedPnl` | P&L | `formatCurrency(value)` with `pnlClassName` colour | Numeric sort | Core visible |
| `unrealisedPnlPct` | P&L % | `formatPercent(value)` with `pnlClassName` colour | Numeric sort | Hidden by default |
| `realisedPnl` | Realised | `formatCurrency(value)` with `pnlClassName` colour | Numeric sort | Hidden by default |
| `changePct` | Day % | `formatPercent(value)` with `pnlClassName` colour, handle null (show "–") | Numeric sort, null to bottom | Core visible |
| `weight` | Weight | `formatPercent(value)` (but without +/- sign, just `value.toFixed(2) + "%"`) | Numeric sort | Core visible |
| `sector` | Sector | Badge component | String sort | Hidden by default |
| `strategy` | Strategy | Badge component | String sort | Hidden by default |
| `platform` | Broker | Plain text | String sort | Hidden by default |

Each column header should use a sortable header pattern: a Button with `variant="ghost"` that toggles sorting on click. Show sort direction indicator (ArrowUp/ArrowDown/ArrowUpDown from lucide-react).

Create a reusable `SortableHeader` component within the file for DRY headers.

For numeric columns with `pnlClassName` colouring: wrap the cell content in a `<span>` with the computed className from `pnlClassName(value)`.

Import formatting functions from `@/lib/format`.

For the `symbol` column cell: render as a Next.js `Link` component pointing to `/symbol/${row.original.symbol}` with underline-on-hover styling. This satisfies PORT-12 (clicking a symbol navigates to detail page).

For `changePct` null handling: use a custom sortingFn that pushes null values to the bottom regardless of sort direction.

Export the columns array: `export const columns: ColumnDef<DisplayHolding>[]`.

**File 3: `src/components/portfolio/holdings-table.tsx`**

"use client" directive. The main interactive table component.

Props: `{ holdings: DisplayHolding[] }`.

State management:
- `sorting` state initialised to `[{ id: "weight", desc: true }]` (default sort: weight descending per context decision)
- `columnFilters` state for symbol search
- `columnVisibility` from `useColumnVisibility()` hook

TanStack Table setup with `useReactTable`:
- `data: holdings`
- `columns` from the column definitions file
- `state: { sorting, columnFilters, columnVisibility }`
- `onSortingChange: setSorting`
- `onColumnFiltersChange: setColumnFilters`
- `onColumnVisibilityChange: setColumnVisibility` (from the hook)
- `getCoreRowModel: getCoreRowModel()`
- `getSortedRowModel: getSortedRowModel()`
- `getFilteredRowModel: getFilteredRowModel()`

UI structure:
1. **Toolbar row** with:
   - Search input (left): `Input` component with `placeholder="Search symbols..."`, filtering the `symbol` column. Use `table.getColumn("symbol")?.getFilterValue()` and `setFilterValue()`.
   - Column visibility dropdown (right): `DropdownMenu` with `DropdownMenuTrigger` (a Button with "Columns" label and Settings2 icon from lucide-react). `DropdownMenuContent` lists all toggleable columns as `DropdownMenuCheckboxItem` elements. Each item calls `column.toggleVisibility()` on change.

2. **Table**: Render using shadcn `Table`, `TableHeader`, `TableBody`, `TableRow`, `TableHead`, `TableCell` components. Map over `table.getHeaderGroups()` for headers, `table.getRowModel().rows` for body rows. Use `flexRender` for cell content.

3. **Empty state**: If `table.getRowModel().rows.length === 0`, show a `TableRow` with a single cell spanning all columns: "No holdings found."

4. **Results count**: Below the table, show "Showing {filteredCount} of {totalCount} holdings" in muted text.

Row click behaviour: clicking anywhere on a row (except links) navigates to `/symbol/{symbol}`. Use `useRouter` from `next/navigation` and attach `onClick` to the `TableRow` with `cursor-pointer hover:bg-muted/50` classes. The symbol Link in the cell already handles its own click, so use `e.stopPropagation()` on it if needed, or simply let the row click handle navigation (both go to the same URL so it's fine).

Export: `export function HoldingsTable({ holdings }: { holdings: DisplayHolding[] })`.
  </action>
  <verify>
`pnpm typecheck` passes. All three files exist. `holdings-table.tsx` imports from `holdings-columns.tsx` and `use-column-visibility.ts`. Column definitions cover all required fields (symbol, name, shares, avgCost, totalCost, currentPrice, marketValue, unrealisedPnl, unrealisedPnlPct, realisedPnl, changePct, weight, sector, strategy, platform).
  </verify>
  <done>Holdings table component renders with TanStack Table sorting, symbol search filtering, column visibility dropdown with localStorage persistence, and row click navigation. Default sort: weight descending. Core 6 columns visible by default, 9 additional columns toggle-able.</done>
</task>

<task type="auto">
  <name>Task 2: Create symbol detail page and wire holdings table into page.tsx</name>
  <files>src/app/symbol/[symbol]/page.tsx, src/app/page.tsx</files>
  <action>
Create the symbol detail drill-down page and wire the HoldingsTable into the main portfolio page.

**File 1: `src/app/symbol/[symbol]/page.tsx`**

Server Component (no "use client"). This page displays detailed information for a single symbol.

Accepts `params: Promise<{ symbol: string }>` (Next.js 16 async params pattern).

Data fetching:
1. Resolve `params`, uppercase the symbol
2. Fetch in parallel using `Promise.all`:
   - `listRecords<SymbolRecord>("symbols", { where: \`(symbol,eq,${upperSymbol})\` })` -- get symbol data
   - `getAllRecords<TransactionRecord>("transactions", { where: \`(symbol,eq,${upperSymbol})\`, sort: "-date" })` -- get all transactions sorted by date descending
3. Extract `symbolData` from `symbolResult.list[0]`. If not found, render a "Symbol not found" message and return early.
4. Compute holding using `computeHolding(transactions, symbolData.current_price)` and convert via `toDisplay()`.

Page layout with sections:

**Section 1: Header**
- Back link/button (using `Link` to `/`) or a "Back to Portfolio" link
- Symbol as large heading (e.g., "AAPL") with name as subtitle (e.g., "Apple Inc.")

**Section 2: Position Summary** (Card)
- Display in a grid of stat items:
  - Current Price: `formatCurrency(symbolData.current_price)`
  - Shares: `formatNumber(holding.shares, 4)`
  - Avg Cost: `formatCurrency(holding.avgCost)`
  - Market Value: `formatCurrency(holding.marketValue)`
  - Unrealised P&L: `formatCurrency(holding.unrealisedPnl)` with `pnlClassName` colour + percentage
  - Realised P&L: `formatCurrency(holding.realisedPnl)` with `pnlClassName` colour
  - Day Change: `formatPercent(symbolData.change_pct)` with `pnlClassName` colour (handle null)
  - Weight: show "N/A" (weight requires full portfolio context, not available on single-symbol page)

**Section 3: Fundamentals** (Card)
- Display key fundamental data from `SymbolRecord`:
  - P/E Ratio: `symbolData.pe_ratio` (handle null: show "–")
  - EPS: `symbolData.eps`
  - Market Cap: `formatCompact(symbolData.market_cap)` (handle null)
  - Dividend Yield: `symbolData.dividend_yield` formatted as percentage (handle null)
  - 52-Week Range: `formatCurrency(symbolData.year_low) – formatCurrency(symbolData.year_high)` (handle nulls)
  - Forward P/E: `symbolData.forward_pe` (handle null)
  - PEG Ratio: `symbolData.peg_ratio` (handle null)
  - ROE: `symbolData.roe` formatted as percentage (handle null)

**Section 4: Transaction History** (Card with Table)
- Render transactions in a simple HTML table (no TanStack Table needed here -- it's a read-only list):
  - Columns: Date, Type (Buy/Sell with Badge), Price, Shares, Amount, Platform
  - Sort: already sorted by date descending from the query
  - Type column: use `Badge` with `variant="default"` for Buy and `variant="secondary"` for Sell (or appropriate variants)
  - Format: date with locale string, price/amount with `formatCurrency`, shares with `formatNumber`

Use `generateMetadata` to set the page title dynamically: `{ title: \`${symbol} | Folio\` }`.

Handle edge cases:
- Symbol not found: show "Symbol not found" with back link
- No transactions: show "No transactions for this symbol"
- `current_price` is null: show position summary with "–" for computed values

**File 2: `src/app/page.tsx`**

Update the existing page shell (created in plan 03-01) to import and render the `HoldingsTable` component in the holdings table placeholder section.

Replace the holdings table placeholder with:
```tsx
<HoldingsTable holdings={data.holdings} />
```

Import `HoldingsTable` from `@/components/portfolio/holdings-table`.

Keep the other placeholder sections (summary cards, charts, movers) as-is -- they will be replaced in plan 03-03.
  </action>
  <verify>
`pnpm typecheck` passes. `pnpm lint` passes. `src/app/symbol/[symbol]/page.tsx` exists and exports a default async function. `src/app/page.tsx` imports and renders `<HoldingsTable>`. The symbol page imports from `@/lib/nocodb`, `@/lib/calculations`, `@/lib/format`, and `@/lib/types`.
  </verify>
  <done>Symbol detail page at `/symbol/[symbol]` shows position summary, fundamentals, and transaction history. Holdings table component wired into the main page with real data. Clicking a symbol in the table navigates to its detail page.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes with zero errors
2. `pnpm lint` passes
3. Holdings table renders with sortable columns (click header toggles sort)
4. Symbol search input filters the table by partial symbol match
5. Column visibility dropdown shows all toggle-able columns, persisted in localStorage
6. Default sort: weight descending
7. Core columns (Symbol, Price, Market Value, P&L, Day %, Weight) visible by default
8. P&L and day change values coloured green/red using `text-gain`/`text-loss`
9. Clicking a row navigates to `/symbol/AAPL` (or whichever symbol)
10. Symbol detail page shows position summary, fundamentals, and transaction table
11. Symbol detail page handles "not found" gracefully
</verification>

<success_criteria>
- Holdings table displays all PORT-01 columns with sort and filter (PORT-02)
- Only shares > 0 holdings shown (PORT-03, filtered in data assembly)
- Column visibility toggleable and persisted across sessions
- Symbol drill-down page works (PORT-12) with position summary, fundamentals, and transactions
- Gain/loss colouring consistent across all financial values
</success_criteria>

<output>
After completion, create `.planning/phases/03-portfolio-overview/03-02-SUMMARY.md`
</output>
