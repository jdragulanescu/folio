---
phase: 01-foundation-data-migration
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/nocodb.ts
  - src/lib/types.ts
autonomous: true

must_haves:
  truths:
    - "Importing nocodb.ts in a Client Component causes a build-time error via server-only guard"
    - "listRecords fetches a single page of records with filtering, sorting, limit, and offset support"
    - "getAllRecords auto-paginates through all pages using pageInfo.isLastPage"
    - "fetchParallel fetches from multiple tables concurrently with type-safe results"
    - "TypeScript interfaces exist for all 8 NocoDB tables with correct field types"
    - "Broker constants distinguish active (IBKR, Trading 212, Robinhood) from archived (Freetrade, Stake, eToro)"
  artifacts:
    - path: "src/lib/nocodb.ts"
      provides: "Typed NocoDB REST client with server-only guard, auto-pagination, parallel fetch"
      exports: ["listRecords", "getAllRecords", "fetchParallel", "getRecord", "createRecord", "updateRecord"]
      contains: "server-only"
    - path: "src/lib/types.ts"
      provides: "TypeScript interfaces for all 8 NocoDB tables plus broker constants"
      exports: ["Symbol", "Transaction", "Option", "Deposit", "Dividend", "MonthlySnapshot", "PriceHistory", "Setting", "BROKERS", "Broker", "ActiveBroker", "ArchivedBroker"]
      contains: "BROKERS"
  key_links:
    - from: "src/lib/nocodb.ts"
      to: "server-only"
      via: "import 'server-only' at module top"
      pattern: "import.*server-only"
    - from: "src/lib/nocodb.ts"
      to: "src/lib/types.ts"
      via: "import types for generic constraints"
      pattern: "import.*types"
---

<objective>
Build a typed NocoDB REST client for the Next.js dashboard with server-only import guard, auto-pagination, parallel table fetching, and TypeScript interfaces for all 8 NocoDB tables.

Purpose: Every data-displaying page in the dashboard fetches from NocoDB through this client. It must enforce server-only usage (protecting the API token), handle pagination automatically (tables can have 1000+ rows), and support parallel fetching (portfolio page needs symbols + transactions + options simultaneously). The type definitions ensure type safety across all phases.

Output: Two files — `nocodb.ts` (the client) and `types.ts` (the interfaces) — that all subsequent phases import.
</objective>

<execution_context>
@/Users/skylight/.claude/sky/workflows/execute-plan.md
@/Users/skylight/.claude/sky/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-data-migration/01-RESEARCH.md
@.planning/phases/01-foundation-data-migration/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TypeScript type definitions and broker constants</name>
  <files>src/lib/types.ts</files>
  <action>
    Create `src/lib/types.ts` with interfaces matching the NocoDB table schemas from FOLIO-IMPLEMENTATION-PLAN.md.

    **Broker constants (DATA-12):**
    ```typescript
    export const BROKERS = {
      active: ["IBKR", "Trading 212", "Robinhood"] as const,
      archived: ["Freetrade", "Stake", "eToro"] as const,
    } as const

    export type ActiveBroker = (typeof BROKERS.active)[number]
    export type ArchivedBroker = (typeof BROKERS.archived)[number]
    export type Broker = ActiveBroker | ArchivedBroker
    ```

    **Table name type:**
    ```typescript
    export type TableName = "symbols" | "transactions" | "options" | "deposits" | "dividends" | "monthly_snapshots" | "price_history" | "settings"
    ```

    **NocoDB record interfaces** — each must include `Id: number` (NocoDB auto-generated primary key) and `CreatedAt?: string`, `UpdatedAt?: string` (NocoDB auto-generated timestamps):

    1. `SymbolRecord` — symbol (string), name (string), sector (string | null), strategy (string | null), current_price (number | null), previous_close (number | null), change_pct (number | null), day_high (number | null), day_low (number | null), year_high (number | null), year_low (number | null), market_cap (number | null), pe_ratio (number | null), eps (number | null), dividend_yield (number | null), avg_volume (number | null), last_price_update (string | null)

    2. `TransactionRecord` — symbol (string), name (string), type ("Buy" | "Sell"), price (number), shares (number), amount (number), eps (number | null), date (string), platform (Broker)

    3. `OptionRecord` — ticker (string), opened (string), strategy_type ("Wheel" | "LEAPS" | "Spread"), call_put ("Call" | "Put"), buy_sell ("Buy" | "Sell"), expiration (string), strike (number), delta (number | null), iv_pct (number | null), moneyness ("OTM" | "ATM" | "ITM" | null), qty (number), premium (number), collateral (number | null), status ("Open" | "Closed" | "Expired" | "Rolled" | "Assigned"), close_date (string | null), close_premium (number | null), profit (number | null), days_held (number | null), return_pct (number | null), annualised_return_pct (number | null), notes (string | null)

    4. `DepositRecord` — month (string), amount (number), platform (Broker)

    5. `DividendRecord` — symbol (string), amount (number), date (string), platform (Broker)

    6. `MonthlySnapshotRecord` — month (string), total_invested (number | null), portfolio_value (number | null), gain_loss (number | null), gain_loss_pct (number | null), dividend_income (number | null), options_premium (number | null), options_capital_gains (number | null), total_deposits (number | null)

    7. `PriceHistoryRecord` — symbol (string), date (string), close_price (number), volume (number | null)

    8. `SettingRecord` — key (string), value (string), description (string | null)

    **Pagination response type:**
    ```typescript
    export interface PageInfo {
      totalRows: number
      page: number
      pageSize: number
      isFirstPage: boolean
      isLastPage: boolean
    }

    export interface NocoDBListResponse<T> {
      list: T[]
      pageInfo: PageInfo
    }
    ```

    **List params type:**
    ```typescript
    export interface ListParams {
      where?: string
      sort?: string
      limit?: number
      offset?: number
      fields?: string[]
    }
    ```

    IMPORTANT: Use `number | null` for optional numeric fields because NocoDB returns `null` for empty Decimal/Number cells, not `undefined`. Use string literal unions for SingleSelect fields. Every interface name should end with `Record` to distinguish from computed types added in later phases.
  </action>
  <verify>
    - `pnpm tsc --noEmit` — no type errors
    - `grep "BROKERS" src/lib/types.ts` — broker constants exist
    - `grep "SymbolRecord" src/lib/types.ts` — all 8 record types present
    - `grep "NocoDBListResponse" src/lib/types.ts` — pagination type present
  </verify>
  <done>
    TypeScript interfaces for all 8 NocoDB tables are defined with correct field types, null annotations, and string literal unions. Broker constants distinguish active from archived. Pagination and list param types are exported for use by the client.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build the NocoDB REST client with server-only guard</name>
  <files>src/lib/nocodb.ts</files>
  <action>
    Create `src/lib/nocodb.ts` with:

    **Server-only guard:**
    ```typescript
    import "server-only"
    ```
    This MUST be the first import. It causes a build-time error if any Client Component imports this module.

    **Environment configuration:**
    Read from `process.env` — do NOT prefix with `NEXT_PUBLIC_`:
    ```typescript
    const BASE_URL = process.env.NOCODB_BASE_URL!
    const API_TOKEN = process.env.NOCODB_API_TOKEN!

    const TABLE_IDS: Record<TableName, string> = {
      symbols: process.env.NOCODB_TABLE_SYMBOLS!,
      transactions: process.env.NOCODB_TABLE_TRANSACTIONS!,
      options: process.env.NOCODB_TABLE_OPTIONS!,
      deposits: process.env.NOCODB_TABLE_DEPOSITS!,
      dividends: process.env.NOCODB_TABLE_DIVIDENDS!,
      monthly_snapshots: process.env.NOCODB_TABLE_SNAPSHOTS!,
      price_history: process.env.NOCODB_TABLE_PRICE_HISTORY!,
      settings: process.env.NOCODB_TABLE_SETTINGS!,
    }
    ```

    **Core fetch wrapper:**
    ```typescript
    async function nocodbFetch<T>(path: string, init?: RequestInit): Promise<T>
    ```
    - Prepend `BASE_URL` to path
    - Set headers: `xc-token: API_TOKEN`, `Content-Type: application/json`
    - Merge any additional headers from `init`
    - Set `cache: "no-store"` to always get fresh data
    - On non-OK response, throw `Error` with status code and response text
    - Parse and return JSON as `T`

    **Exported functions:**

    1. `listRecords<T>(table: TableName, params?: ListParams): Promise<NocoDBListResponse<T>>`
       - Build URLSearchParams from params (where, sort, limit, offset, fields joined by comma)
       - Call `nocodbFetch` with `GET /api/v2/tables/{tableId}/records?{query}`

    2. `getAllRecords<T>(table: TableName, params?: Omit<ListParams, "limit" | "offset">): Promise<T[]>`
       - Auto-paginate with PAGE_SIZE = 200
       - Loop: call listRecords with incrementing offset
       - Stop when `pageInfo.isLastPage` is true
       - Return accumulated array of all records

    3. `getRecord<T>(table: TableName, rowId: number): Promise<T>`
       - Call `nocodbFetch` with `GET /api/v2/tables/{tableId}/records/{rowId}`

    4. `createRecord<T>(table: TableName, data: Partial<T>): Promise<T>`
       - Call `nocodbFetch` with `POST /api/v2/tables/{tableId}/records`
       - Body: JSON of `data`

    5. `updateRecord<T>(table: TableName, rowId: number, data: Partial<T>): Promise<T>`
       - Call `nocodbFetch` with `PATCH /api/v2/tables/{tableId}/records`
       - Body: JSON of `{ Id: rowId, ...data }`

    6. `fetchParallel<T extends readonly unknown[]>(...fetchers: { [K in keyof T]: () => Promise<T[K]> }): Promise<T>`
       - Execute all fetcher functions concurrently via `Promise.all`
       - Return typed tuple of results
       - Usage example: `const [symbols, transactions] = await fetchParallel(() => getAllRecords<SymbolRecord>("symbols"), () => getAllRecords<TransactionRecord>("transactions"))`

    Import `TableName`, `ListParams`, `NocoDBListResponse` from `./types`.

    IMPORTANT: The `nocodbFetch` function should NOT be exported — it's internal. Only the 6 named functions above are exported.
    IMPORTANT: Use `cache: "no-store"` on all fetches — NocoDB data changes via migration and sync.
    IMPORTANT: NocoDB rate limit is 5 req/sec per user. The `getAllRecords` sequential loop naturally stays under this. `fetchParallel` is for different tables, not pages of the same table.
  </action>
  <verify>
    - `pnpm tsc --noEmit` — no type errors
    - `grep 'import "server-only"' src/lib/nocodb.ts` — server-only guard present as first import
    - `grep "export async function" src/lib/nocodb.ts` — all 6 functions exported
    - `grep "NEXT_PUBLIC" src/lib/nocodb.ts` — must return NO results (env vars are server-only)
    - `grep "cache.*no-store" src/lib/nocodb.ts` — no-store caching confirmed
    - `pnpm build` — build succeeds
  </verify>
  <done>
    The NocoDB TypeScript client is complete with server-only guard (build-time error on client import), auto-pagination via getAllRecords, parallel table fetching via fetchParallel, and typed CRUD operations. All env vars are server-side only. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` — build succeeds without errors
2. `pnpm tsc --noEmit` — TypeScript compilation clean
3. `grep 'import "server-only"' src/lib/nocodb.ts` returns a match
4. `grep "NEXT_PUBLIC" src/lib/nocodb.ts` returns zero matches
5. `src/lib/types.ts` exports interfaces for all 8 tables plus broker constants
6. `src/lib/nocodb.ts` exports listRecords, getAllRecords, getRecord, createRecord, updateRecord, fetchParallel
7. `getAllRecords` uses `pageInfo.isLastPage` to terminate pagination loop
</verification>

<success_criteria>
- The NocoDB client refuses to import on the client side (server-only guard)
- Records can be fetched with filtering, sorting, pagination, and field selection
- Auto-pagination fetches all records from tables with >200 rows
- Multiple tables can be fetched in parallel with type-safe results
- All 8 NocoDB table interfaces are defined with correct types
- Broker constants distinguish active from archived brokers
- Requirements covered: DATA-08 (typed client with parallel fetch, auto-pagination, server-only guard), DATA-12 (broker active/archived distinction)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-data-migration/01-02-SUMMARY.md`
</output>
