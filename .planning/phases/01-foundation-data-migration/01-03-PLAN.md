---
phase: 01-foundation-data-migration
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/requirements.txt
  - scripts/migrate.py
  - scripts/utils/__init__.py
  - scripts/utils/nocodb_client.py
  - .env.example
autonomous: false

must_haves:
  truths:
    - "Running the migration script creates all 8 NocoDB tables if they don't exist"
    - "All 964 transactions are imported with correct symbol, price, shares, amount, date, platform, and Buy/Sell type"
    - "164 Wheel options and 36 LEAPS options are imported into a single options table with strategy_type distinction"
    - "Deposit rows are unpivoted from the pivot format (one row per month) into individual records (one per platform per month)"
    - "Platform names are normalised: Etoro to eToro, Hood to Robinhood"
    - "Unique symbols are extracted from transactions with sector and strategy mappings from the Sectors-1 table"
    - "Monthly snapshot data from the Monthly Tracker is imported"
    - "The script prints a summary of imported record counts for validation"
    - "Running the script a second time does not create duplicate tables (idempotent table creation)"
  artifacts:
    - path: "scripts/migrate.py"
      provides: "One-time migration script reading .numbers file and importing all data into NocoDB"
      contains: "numbers_parser"
    - path: "scripts/utils/nocodb_client.py"
      provides: "Python NocoDB REST client wrapper with table creation, bulk insert, and listing"
      contains: "NocoDBClient"
    - path: "scripts/requirements.txt"
      provides: "Python dependencies: numbers-parser, requests, python-dotenv"
      contains: "numbers-parser"
    - path: ".env.example"
      provides: "Environment variable template for NocoDB connection and base ID"
      contains: "NOCODB_BASE_ID"
  key_links:
    - from: "scripts/migrate.py"
      to: "scripts/utils/nocodb_client.py"
      via: "import NocoDBClient"
      pattern: "from utils.nocodb_client import"
    - from: "scripts/migrate.py"
      to: "stocks-v2.numbers"
      via: "Document() reads the .numbers file"
      pattern: "Document.*numbers"
    - from: "scripts/utils/nocodb_client.py"
      to: "NocoDB REST API"
      via: "HTTP requests to /api/v2/"
      pattern: "/api/v2/"
---

<objective>
Build a Python migration script that reads the `stocks-v2.numbers` spreadsheet and imports all historical data (transactions, options, deposits, symbols, monthly snapshots) into NocoDB, with platform name normalisation, deposit unpivoting, and validation against expected record counts.

Purpose: This is the data foundation for the entire dashboard. All 964 transactions, ~200 options, 74 months of deposits, and monthly performance snapshots must be accurately imported into NocoDB before any dashboard page can display real data. The migration runs once and must be idempotent (safe to re-run if tables already exist).

Output: A Python migration script (`scripts/migrate.py`) with a reusable NocoDB client (`scripts/utils/nocodb_client.py`) that creates tables and imports all data.
</objective>

<execution_context>
@/Users/skylight/.claude/sky/workflows/execute-plan.md
@/Users/skylight/.claude/sky/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-data-migration/01-RESEARCH.md
@FOLIO-IMPLEMENTATION-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Python NocoDB client and project setup</name>
  <files>
    scripts/requirements.txt
    scripts/utils/__init__.py
    scripts/utils/nocodb_client.py
    .env.example
  </files>
  <action>
    **Directory structure:** Create `scripts/` and `scripts/utils/` directories.

    **requirements.txt:** Create `scripts/requirements.txt`:
    ```
    numbers-parser>=4.18.0
    requests>=2.32.0
    python-dotenv>=1.0.0
    ```
    Add a comment at the top: `# System dependency: brew install snappy (macOS) or apt-get install libsnappy-dev (Linux)`

    **.env.example:** Create root `.env.example`:
    ```
    # NocoDB Connection (for Python migration scripts)
    NOCODB_BASE_URL=http://localhost:8080
    NOCODB_API_TOKEN=your_nocodb_api_token
    NOCODB_BASE_ID=your_base_id
    ```

    **__init__.py:** Create empty `scripts/utils/__init__.py`.

    **nocodb_client.py:** Create `scripts/utils/nocodb_client.py` with class `NocoDBClient`:

    Constructor: `__init__(self, base_url: str, api_token: str, base_id: str)`
    - Store base_url (strip trailing slash), api_token, base_id
    - Create headers dict: `{"xc-token": api_token, "Content-Type": "application/json"}`

    Methods:

    1. `list_tables(self) -> list[dict]`:
       - GET `/api/v2/meta/bases/{base_id}/tables`
       - Return `response.json().get("list", [])`

    2. `create_table(self, table_def: dict) -> dict`:
       - POST `/api/v2/meta/bases/{base_id}/tables`
       - Body: table_def (JSON)
       - Return response.json()

    3. `ensure_tables(self, schemas: dict[str, dict]) -> dict[str, str]`:
       - Call `list_tables()` to get existing tables
       - Build `existing = {t["title"]: t["id"] for t in self.list_tables()}`
       - For each schema name: if exists, use existing ID; if not, call `create_table()`
       - Print status for each table: "Table 'X' already exists" or "Created table 'X'"
       - Return `{name: table_id}` mapping

    4. `bulk_insert(self, table_id: str, records: list[dict], batch_size: int = 100) -> int`:
       - Insert records in batches of `batch_size`
       - POST `/api/v2/tables/{table_id}/records` with array body for each batch
       - Raise on HTTP error
       - Return total count inserted

    5. `get_records(self, table_id: str, params: dict | None = None) -> dict`:
       - GET `/api/v2/tables/{table_id}/records` with query params
       - Return response.json()

    6. `delete_all_records(self, table_id: str) -> int`:
       - Fetch all record IDs (paginate with limit=200)
       - DELETE `/api/v2/tables/{table_id}/records` with body `[{"Id": id}, ...]` in batches
       - Return total deleted count
       - This is used for re-running the migration (clear before re-import)

    All methods should call `response.raise_for_status()` after requests.
    Print batch progress for bulk_insert: `"  Inserted {batch_num}/{total_batches} ({count} records)"`
  </action>
  <verify>
    - `ls scripts/requirements.txt scripts/utils/__init__.py scripts/utils/nocodb_client.py .env.example` — all files exist
    - `grep "numbers-parser" scripts/requirements.txt` — dependency listed
    - `grep "class NocoDBClient" scripts/utils/nocodb_client.py` — class exists
    - `grep "ensure_tables" scripts/utils/nocodb_client.py` — idempotent table creation method exists
    - `grep "bulk_insert" scripts/utils/nocodb_client.py` — bulk insert method exists
    - `python3 -c "import ast; ast.parse(open('scripts/utils/nocodb_client.py').read())"` — valid Python syntax
  </verify>
  <done>
    The Python NocoDB client class is complete with table creation (idempotent via ensure_tables), bulk record insertion in batches, record fetching, and record deletion for re-runs. requirements.txt lists all dependencies. .env.example provides the connection template.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build the migration script with data extraction and import</name>
  <files>scripts/migrate.py</files>
  <action>
    Create `scripts/migrate.py` that reads `stocks-v2.numbers` and imports all data into NocoDB.

    **Imports and config:**
    ```python
    import os
    import sys
    import math
    from datetime import datetime
    from numbers_parser import Document
    from utils.nocodb_client import NocoDBClient
    from dotenv import load_dotenv
    ```

    **Platform normalisation mapping (DATA-04):**
    ```python
    PLATFORM_MAP = {
        "Etoro": "eToro",
        "Hood": "Robinhood",
        "Trading 212": "Trading 212",
        "IBKR": "IBKR",
        "Freetrade": "Freetrade",
        "Stake": "Stake",
        "Robinhood": "Robinhood",
        "eToro": "eToro",
    }
    ```
    The `normalise_platform(raw)` function should: strip whitespace, look up in PLATFORM_MAP, return matched value or original string if not found. Handle None by returning None.

    **Date formatting:**
    `format_date(value)` function: if datetime, use `.strftime("%Y-%m-%d")`. If string, try multiple formats ("%Y-%m-%d", "%d/%m/%Y", "%m/%d/%Y"). Return None if not parseable. Return None if value is None.

    **Table schemas (DATA-02):**
    Define `TABLE_SCHEMAS` dict with 8 table definitions matching EXACTLY the schemas in FOLIO-IMPLEMENTATION-PLAN.md Part 3. Each key is the table name, value is the full creation payload with `table_name` and `columns` array. Use these uidt values:
    - SingleLineText, LongText, Number, Decimal, Date, DateTime, SingleSelect, Checkbox

    For SingleSelect columns, include `dtxp` with the allowed values as a comma-separated string in single quotes:
    - transactions.platform: `"'IBKR','Trading 212','Freetrade','Stake','eToro','Robinhood'"`
    - transactions.type: `"'Buy','Sell'"`
    - options.strategy_type: `"'Wheel','LEAPS','Spread'"`
    - etc. (all SingleSelect columns per the implementation plan)

    **Main migrate() function:**

    1. Load environment: `load_dotenv()`, read NOCODB_BASE_URL, NOCODB_API_TOKEN, NOCODB_BASE_ID from env.

    2. Open .numbers file: `doc = Document("stocks-v2.numbers")` (relative to project root — the script should be run from the project root: `python scripts/migrate.py`).

    3. Create NocoDB client and ensure all 8 tables exist.

    4. **Extract symbols (DATA-05):**
       - Read transactions table to collect unique symbols
       - Read Sectors-1 table from Portfolio sheet to build `{symbol: sector}` mapping
       - For each unique symbol: create a record with symbol name, sector (from Sectors-1), strategy (from Sectors-1 if available, else null)
       - Bulk insert into symbols table

    5. **Import transactions (DATA-01):**
       - Read "Transactions" table from "Transactions" sheet
       - Get headers from first row, data from remaining rows
       - For each data row: skip if symbol cell is None or empty string
       - Map columns: Symbol (col 0), Name (col 1), Price (col 2), Shares (col 3), EPS (col 4), Date (col 5), Platform (col 6), Amount (col 7)
       - Determine type: "Sell" if shares < 0, "Buy" otherwise
       - Use `abs(shares)` for the shares field
       - Apply `normalise_platform()` to platform
       - Apply `format_date()` to date
       - Convert numeric values with `float()`, handle None as 0
       - Bulk insert into transactions table

    6. **Import deposits (DATA-03 — unpivot):**
       - Read "Deposited" table from "Transactions" sheet
       - Column mapping: Month (col 0), Total (col 1), IBKR (col 2), Trading 212 (col 3), Freetrade (col 4), Stake (col 5), Etoro (col 6), Hood (col 7)
       - For each row (skip header): extract month via format_date
       - For each platform column (cols 2-7): if value is not None and float(value) != 0, create a deposit record with month, amount, and normalised platform name
       - Bulk insert into deposits table

    7. **Import options — Wheel (DATA-06):**
       - Read "Options Wheel Strategy" table from "Options" sheet
       - Column mapping (based on implementation plan): Ticker, Opened, Strategy, C/P, Buy/Sell, Expiration, Strike, Delta, IV%, Moneyness, QTY, Premium, Collateral, Status, Close Date, Close Premium, Profit, Days Held, Return%, Annualised Return%, Notes
       - **IMPORTANT:** The actual column positions may differ. Read the header row first and map column names to indices dynamically. This makes the script resilient to column order changes.
       - Set `strategy_type = "Wheel"` for all rows
       - Skip rows where ticker is None or empty
       - Handle numeric conversion carefully: None becomes None (not 0) for optional fields like delta, iv_pct, close_premium, profit, etc.
       - Apply format_date to date columns (opened, expiration, close_date)
       - Collect all Wheel records

    8. **Import options — LEAPS (DATA-06):**
       - Read "Options LEAPS" table from "Options" sheet
       - Same column mapping logic as Wheel
       - Set `strategy_type = "LEAPS"` for all rows
       - Collect all LEAPS records
       - Combine Wheel + LEAPS records and bulk insert into options table

    9. **Import monthly snapshots:**
       - Read "Monthly Tracker" table from "Transactions" sheet
       - Map columns: Month, Invested so far (-> total_invested), Portfolio Value (-> portfolio_value), Gain/Loss (-> gain_loss), Gain/Loss % (-> gain_loss_pct), plus additional columns for dividend_income, options_premium, options_capital_gains, total_deposits
       - Read header row dynamically to map column names to indices
       - Skip empty/None month rows
       - Bulk insert into monthly_snapshots table

    10. **Seed settings table:**
        - Insert default settings:
          - dividend_income_goal: "5000", "Annual dividend income target in £"
          - salary: "45000", "Annual salary for UK tax calculations"
          - tax_year: "2024-25", "Current tax year"
          - default_currency: "GBP", "Display currency"

    11. **Print summary (DATA-07):**
        ```
        === Migration Summary ===
        Symbols:           {count} (expected: ~120 unique)
        Transactions:      {count} (expected: 964)
        Options (Wheel):   {wheel_count} (expected: 164)
        Options (LEAPS):   {leaps_count} (expected: 36)
        Options (Total):   {total_count} (expected: ~200)
        Deposits:          {count} (expected: ~{74 months * avg platforms})
        Monthly Snapshots: {count} (expected: ~86)
        Settings:          {count}

        Table IDs for dashboard/.env.local:
        NOCODB_TABLE_SYMBOLS={id}
        NOCODB_TABLE_TRANSACTIONS={id}
        NOCODB_TABLE_OPTIONS={id}
        NOCODB_TABLE_DEPOSITS={id}
        NOCODB_TABLE_DIVIDENDS={id}
        NOCODB_TABLE_SNAPSHOTS={id}
        NOCODB_TABLE_PRICE_HISTORY={id}
        NOCODB_TABLE_SETTINGS={id}
        ```

    12. **Command-line options:**
        - `--clean`: Before importing, delete all existing records from all tables (for re-running)
        - Default (no flag): skip if tables have existing records (print warning and counts)
        - Use `sys.argv` for simplicity — no need for argparse for 1 flag

    **Error handling:**
    - Wrap the main migrate() call in try/except
    - Print meaningful error messages for: file not found, NocoDB connection refused, HTTP errors
    - If numbers-parser import fails, suggest `pip install numbers-parser` and `brew install snappy`

    IMPORTANT: Run from project root: `python scripts/migrate.py`. The .numbers file path should be `"stocks-v2.numbers"` (relative to cwd).
    IMPORTANT: NocoDB column names in records must EXACTLY match the column_name in the table schema. Field names are case-sensitive.
    IMPORTANT: NocoDB rejects records with values not in the SingleSelect options. The platform normalisation must produce exactly the values in the dtxp string.
    IMPORTANT: numbers-parser may return date values as datetime or as formatted strings depending on the cell. Always type-check before converting.
  </action>
  <verify>
    - `python3 -c "import ast; ast.parse(open('scripts/migrate.py').read())"` — valid Python syntax
    - `grep "normalise_platform" scripts/migrate.py` — platform normalisation present
    - `grep "format_date" scripts/migrate.py` — date formatting present
    - `grep "strategy_type" scripts/migrate.py` — Wheel/LEAPS distinction present
    - `grep "unpivot\|DEPOSIT_COL_MAP\|Deposited" scripts/migrate.py` — deposit unpivoting logic present
    - `grep "Migration Summary\|expected" scripts/migrate.py` — summary printing present
    - `grep "ensure_tables\|TABLE_SCHEMAS" scripts/migrate.py` — table creation present
    - `grep "NOCODB_TABLE_" scripts/migrate.py` — table ID output present
  </verify>
  <done>
    The migration script reads all data from stocks-v2.numbers, creates 8 NocoDB tables, imports transactions (with Buy/Sell from share sign), unpivots deposits, imports Wheel + LEAPS options with strategy_type distinction, extracts symbols with sector/strategy mappings, imports monthly snapshots, seeds settings, normalises platform names, and prints a validation summary with table IDs for the dashboard .env.local.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Python migration infrastructure: NocoDB REST client wrapper and migration script that reads stocks-v2.numbers and imports all historical data into NocoDB. The script creates tables, normalises platform names, unpivots deposits, and prints validation counts.
  </what-built>
  <how-to-verify>
    1. Set up the Python environment:
       ```bash
       cd /Users/skylight/development/personal/nodes/folio
       python3 -m venv scripts/.venv
       source scripts/.venv/bin/activate
       pip install -r scripts/requirements.txt
       ```
    2. Copy `.env.example` to `.env` and fill in your NocoDB API token and base ID:
       ```bash
       cp .env.example .env
       # Edit .env with your actual NOCODB_API_TOKEN and NOCODB_BASE_ID
       ```
    3. Run the migration:
       ```bash
       python scripts/migrate.py
       ```
    4. Verify the output summary:
       - Transactions count should be ~964
       - Options Wheel count should be ~164
       - Options LEAPS count should be ~36
       - Deposits should have multiple records per month (unpivoted)
       - Monthly Snapshots should be ~86
       - Table IDs should be printed for dashboard config
    5. Open NocoDB at http://localhost:8080 and spot-check:
       - Transactions table has records with "eToro" (not "Etoro") and "Robinhood" (not "Hood")
       - Options table has both "Wheel" and "LEAPS" strategy_type values
       - Deposits table has individual platform records (not pivot format)
    6. Copy the printed table IDs into `dashboard/.env.local`
  </how-to-verify>
  <resume-signal>Type "approved" if migration ran successfully with expected counts, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. `python3 -c "import ast; ast.parse(open('scripts/migrate.py').read())"` — valid syntax
2. `python3 -c "import ast; ast.parse(open('scripts/utils/nocodb_client.py').read())"` — valid syntax
3. `ls scripts/requirements.txt scripts/utils/__init__.py scripts/utils/nocodb_client.py scripts/migrate.py .env.example` — all files exist
4. The migration script defines all 8 table schemas matching FOLIO-IMPLEMENTATION-PLAN.md
5. Platform normalisation maps "Etoro" -> "eToro" and "Hood" -> "Robinhood"
6. Deposits are unpivoted from pivot format to individual records
7. Options have strategy_type "Wheel" or "LEAPS"
8. The summary prints counts and table IDs
</verification>

<success_criteria>
- The migration script runs without errors against the local NocoDB instance
- All 964 transactions are imported with correct types and normalised platforms
- 164 Wheel + 36 LEAPS options are imported with strategy_type distinction
- Deposits are unpivoted into individual records per platform per month
- Symbols are extracted with sector/strategy from the Sectors-1 table
- Monthly snapshots are imported from the Monthly Tracker
- Table IDs are printed in env var format for dashboard configuration
- Running the script twice doesn't create duplicate tables
- Requirements covered: DATA-01, DATA-02, DATA-03, DATA-04, DATA-05, DATA-06, DATA-07
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-data-migration/01-03-SUMMARY.md`
</output>
